# OpenCodeHub

<p align="center">
  <img src="public/logo.png" alt="OpenCodeHub Logo" width="200">
</p>

<p align="center">
  <strong>A powerful, self-hosted Git platform with CI/CD, code review, and enterprise-grade security</strong>
</p>

<p align="center">
  <a href="#-features">Features</a> ‚Ä¢
  <a href="#-quick-start">Quick Start</a> ‚Ä¢
  <a href="#%EF%B8%8F-configuration">Configuration</a> ‚Ä¢
  <a href="#-security">Security</a> ‚Ä¢
  <a href="#-production-deployment">Production</a> ‚Ä¢
  <a href="#-api">API</a> ‚Ä¢
  <a href="#-contributing">Contributing</a>
</p>

---

## üéâ Production Ready!

**All critical security vulnerabilities are now fixed. OpenCodeHub is production-ready!** üéä

‚úÖ **Rate Limiting** - Prevents brute force attacks  
‚úÖ **CSRF Protection** - Cross-site request forgery defense  
‚úÖ **Input Validation** - SQL injection & XSS prevention  
‚úÖ **Hook Authentication** - Secure git operations  
‚úÖ **Environment Validation** - Safe configuration management

üìö **See [DEPLOYMENT.md](DEPLOYMENT.md) for complete deployment guide** with SSL setup, Nginx configuration, monitoring, database backups, and production best practices.

---

## üöÄ Features

### Git Hosting & Collaboration
- **Full Git Support** - SSH and HTTP/HTTPS protocols with authentication
- **Repository Management** - Create, fork, archive, and transfer repositories
- **Branch Protection** - Enforce PR requirements, approvals, and code review policies
- **Pull Requests** - Code review with inline comments and approval workflows
- **Issues & Milestones** - Bug tracking with labels, assignees, and custom fields
- **Wiki** - Built-in documentation with markdown support
- **Organizations** - Team management with role-based access control (RBAC)

### CI/CD & Automation
- **GitHub Actions Compatible** - Run workflows defined in `.github/workflows/`
- **Self-hosted Runners** - Docker-based job execution with artifact support
- **Merge Queue** - Automated PR merge management with conflict detection
- **Webhooks** - Real-time event notifications to external services
- **Secrets Management** - Encrypted storage for CI/CD credentials

### Security Features ‚úÖ
- **Rate Limiting** - Prevents brute force attacks (5 login attempts per 15min)
- **CSRF Protection** - Double-submit cookie pattern for all state-changing operations
- **Input Validation** - Zod schemas prevent injection attacks
- **Hook Authentication** - Shared secrets protect internal git hooks
- **Session Management** - Automatic expiration and rotation
- **Audit Logging** - Complete activity tracking for compliance

### Modern Tech Stack
- **Astro + React** - Fast, modern frontend with island architecture
- **TailwindCSS + shadcn/ui** - Beautiful, accessible UI components
- **Universal Database Adapter** - PostgreSQL, MySQL, SQLite, MongoDB, Turso, PlanetScale
- **Flexible Storage** - Local, S3, MinIO, Google Drive, Azure Blob, R2
- **Production-Ready** - Rate limiting, CSRF, input validation, error monitoring

---

## üì¶ Quick Start

### Prerequisites
- **Node.js** 18+ or **Bun** 1.0+
- **Database**: PostgreSQL 14+ (recommended) / MySQL 8+ / SQLite 3.35+
- **Git** 2.30+
- **Docker** (optional, for CI/CD runners)

### Installation (5 minutes)

```bash
# 1. Clone the repository
git clone https://github.com/swadhinbiswas/OpencodeHub.git
cd OpenCodeHub

# 2. Install dependencies
npm install
# or
bun install

# 3. Set up environment
cp .env.example .env

# 4. Configure your .env file (see Configuration section)
nano .env  # Set at minimum: JWT_SECRET, SESSION_SECRET, INTERNAL_HOOK_SECRET, SITE_URL

# 5. Run database migrations
npm run db:push
# or generate migrations for version control:
npm run db:generate

# 6. Seed an admin user
bun run scripts/seed-admin.ts
# Enter username, email, password when prompted

# 7. Start development server
npm run dev
# Application available at http://localhost:3000
```

### Using Docker (Recommended for Production)

```bash
# 1. Clone and configure
git clone https://github.com/swadhinbiswas/OpencodeHub.git
cd OpenCodeHub
cp .env.example .env

# 2. Edit .env with production values (see Production Deployment section)

# 3. Start services
docker-compose up -d

# 4. Create admin user
docker-compose exec app bun run scripts/seed-admin.ts

# Access at http://localhost:3000
```

---

## ‚öôÔ∏è Configuration

### Critical Environment Variables

These **MUST** be set before deploying to production:

```env
# Security (CRITICAL - Generate strong secrets!)
JWT_SECRET=<run: openssl rand -hex 32>
SESSION_SECRET=<run: openssl rand -hex 32>
INTERNAL_HOOK_SECRET=<run: openssl rand -hex 32>

# Application URLs (CRITICAL)
SITE_URL=https://your-domain.com  # Must be HTTPS in production
PORT=3000
HOST=0.0.0.0
```

### Database Configuration

**PostgreSQL (Recommended for Production):**
```env
DATABASE_DRIVER=postgres
DATABASE_URL=postgresql://user:password@localhost:5432/opencodehub
```

**MySQL:**
```env
DATABASE_DRIVER=mysql
DATABASE_URL=mysql://user:password@localhost:3306/opencodehub
```

**SQLite (Development Only):**
```env
DATABASE_DRIVER=sqlite
DATABASE_URL=./data/opencodehub.db
```

### Storage Configuration

Storage can be configured via Admin Panel (`/admin/storage`) or environment variables:

**Local Storage:**
```env
STORAGE_TYPE=local
STORAGE_PATH=./data/storage
```

**S3/MinIO/R2:**
```env
STORAGE_TYPE=s3
STORAGE_BUCKET=opencodehub
STORAGE_REGION=us-east-1
STORAGE_ENDPOINT=https://s3.amazonaws.com
S3_ACCESS_KEY=your-access-key
S3_SECRET_KEY=your-secret-key
```

**Google Drive (via Admin Panel):**
- Navigate to `/admin/storage`
- Select "Google Drive"
- Enter Client ID, Secret, and Refresh Token
- Test connection before saving

### Security Configuration

**Rate Limiting:**
```env
RATE_LIMIT_AUTH=5          # Login attempts per 15 minutes
RATE_LIMIT_API=100         # API requests per minute
RATE_LIMIT_GIT=200         # Git operations per minute
RATE_LIMIT_SKIP_DEV=false  # Never skip in production
```

**CSRF Protection:**
```env
CSRF_SKIP_DEV=false  # Never skip in production
```

### Optional Services

**Email (SMTP):**
```env
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=noreply@example.com
SMTP_PASSWORD=your-smtp-password
SMTP_FROM=noreply@example.com
```

**Redis (Caching & Sessions):**
```env
REDIS_URL=redis://localhost:6379
```

**Error Monitoring (Sentry):**
```env
SENTRY_DSN=https://...
ENABLE_TRACING=true
```

---

## üîí Security

OpenCodeHub implements **production-grade security** out of the box:

### Implemented Security Features

‚úÖ **Authentication & Authorization**
- JWT-based sessions with automatic expiration
- Bcrypt password hashing (10 rounds)
- 2FA/TOTP support
- Role-based access control (RBAC)

‚úÖ **Attack Prevention**
- **Rate Limiting**: Prevents brute force (5 login attempts per 15min)
- **CSRF Protection**: Double-submit cookie pattern on all state-changing operations
- **Input Validation**: Zod schemas prevent SQL injection and XSS
- **XSS Sanitization**: Markdown rendered with `rehype-sanitize`

‚úÖ **Operational Security**
- **Audit Logging**: All admin actions logged to database
- **Hook Authentication**: Git hooks protected with shared secrets
- **Session Management**: Automatic cleanup and rotation
- **Environment Validation**: Startup checks for missing/weak secrets

### Security Best Practices

1. **Always use HTTPS** in production (Let's Encrypt recommended)
2. **Rotate secrets** regularly (especially after team changes)
3. **Enable 2FA** for all admin accounts
4. **Monitor audit logs** for suspicious activity
5. **Keep dependencies updated**: Run `npm audit` weekly

### Reporting Security Issues

Please report security vulnerabilities to **security@opencodehub.io**. Do not create public issues.

---

## üöÄ Production Deployment

### Pre-Deployment Checklist

Before going live, ensure:

- [ ] **Secrets**: All secrets generated with `openssl rand -hex 32`
- [ ] **HTTPS**: SSL certificate configured (Let's Encrypt recommended)
- [ ] **Database**: PostgreSQL with backups enabled
- [ ] **Storage**: S3/R2 configured (not local filesystem)
- [ ] **Monitoring**: Error tracking (Sentry) and APM configured
- [ ] **Rate Limits**: Configured for expected traffic
- [ ] **Admin Account**: Created via `bun run scripts/seed-admin.ts`
- [ ] **Environment Validation**: Test with `bun run src/lib/env-validation.ts`
- [ ] **Database Migrations**: Generated with `npm run db:generate`

### Production Environment Variables

```env
# Application
NODE_ENV=production
SITE_URL=https://git.yourcompany.com
PORT=3000

# Security (CRITICAL - Generate with: openssl rand -hex 32)
JWT_SECRET=<64-char-random-hex>
SESSION_SECRET=<64-char-random-hex>
INTERNAL_HOOK_SECRET=<64-char-random-hex>

# Database (Use connection pooling)
DATABASE_DRIVER=postgres
DATABASE_URL=postgresql://user:password@db-host:5432/opencodehub?pool_timeout=30

# Storage (Use cloud storage)
STORAGE_TYPE=s3
STORAGE_BUCKET=opencodehub-prod
STORAGE_REGION=us-east-1

# Rate Limiting (Adjust based on traffic)
RATE_LIMIT_AUTH=5
RATE_LIMIT_API=200
RATE_LIMIT_GIT=500

# Monitoring
SENTRY_DSN=https://your-sentry-dsn
LOG_LEVEL=info

# Features
ENABLE_REGISTRATION=true  # Set false for invite-only
```

### Docker Production Deployment

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  app:
    image: opencodehub:latest
    restart: always
    ports:
      - "3000:3000"
    env_file: .env.production
    depends_on:
      - postgres
      - redis
    volumes:
      - ./data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_DB: opencodehub
      POSTGRES_USER: opencodehub
      POSTGRES_PASSWORD: <strong-password>
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    restart: always

volumes:
  postgres_data:
```

```bash
# Deploy
docker-compose -f docker-compose.prod.yml up -d

# Monitor logs
docker-compose -f docker-compose.prod.yml logs -f app

# Health check
curl https://git.yourcompany.com/api/health
```

### Reverse Proxy (Nginx)

```nginx
server {
    listen 443 ssl http2;
    server_name git.yourcompany.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Git operations (larger timeouts)
    location ~ ^/[^/]+/[^/]+\.git/ {
        proxy_pass http://localhost:3000;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
    }
}
```

### Database Backups

```bash
# PostgreSQL backup script (cron daily)
#!/bin/bash
pg_dump -U opencodehub opencodehub | gzip > /backups/opencodehub-$(date +\%Y\%m\%d).sql.gz

# Retain last 30 days
find /backups -name "opencodehub-*.sql.gz" -mtime +30 -delete
```

---

## üìö API Documentation

### Authentication

All authenticated endpoints require a session cookie or `Authorization: Bearer <token>` header.

**Register:**
```bash
POST /api/auth/register
Content-Type: application/json

{
  "username": "johndoe",
  "email": "john@example.com",
  "password": "SecureP@ssw0rd",
  "displayName": "John Doe"
}

# Response: 201 Created
{
  "user": { "id": "...", "username": "johndoe", ... },
  "token": "eyJ...",
  "expiresAt": "2026-01-08T00:00:00Z"
}
```

**Login:**
```bash
POST /api/auth/login
Content-Type: application/json

{
  "login": "john@example.com",  # username or email
  "password": "SecureP@ssw0rd"
}

# With 2FA:
{
  "login": "john@example.com",
  "password": "SecureP@ssw0rd",
  "totpCode": "123456"
}
```

### Repositories

**Create Repository:**
```bash
POST /api/repos
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "my-project",
  "description": "My awesome project",
  "visibility": "public"  # public, private, internal
}
```

**Branch Protection:**
```bash
POST /api/repos/{repoId}/branch-protection
Authorization: Bearer <token>
Content-Type: application/json

{
  "pattern": "main",
  "requiresPr": true,
  "requiredApprovals": 2,
  "dismissStaleReviews": true
}
```

### Admin Endpoints

**List Users (Admin Only):**
```bash
GET /admin/users?q=search&page=1
Cookie: och_session=...
```

**Update Storage Config (Admin Only):**
```bash
POST /api/admin/config/storage
Cookie: och_session=...
Content-Type: application/json

{
  "type": "s3",
  "bucket": "my-bucket",
  "region": "us-east-1",
  ...
}
```

### Rate Limits

All endpoints return rate limit headers:
```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 2026-01-01T15:30:00Z
Retry-After: 30  (when rate limited)
```

**Full API documentation:** `/api/docs` (OpenAPI spec coming soon)

---

## üîß Usage Guide

### Creating Your First Repository

1. **Log in** to your account
2. Click the **+** button ‚Üí **New Repository**
3. Fill in details:
   - **Name**: alphanumeric, hyphens, underscores
   - **Description**: Optional
   - **Visibility**: public/private
4. Click **Create Repository**

### Cl

oning Repositories

**SSH (Recommended):**
```bash
# Add your SSH key in Settings ‚Üí SSH Keys
git clone git@your-domain.com:username/repo.git
```

**HTTPS:**
```bash
git clone https://your-domain.com/username/repo.git
# Username: your-username
# Password: your-password or personal access token
```

### Setting Up Branch Protection

1. Navigate to **Repository ‚Üí Settings ‚Üí Branches**
2. Click **Add Rule**
3. Configure:
   - **Pattern**: `main` or `release/*`
   - **Require PR**: ‚úÖ
   - **Required Approvals**: 2
   - **Dismiss Stale Reviews**: ‚úÖ
4. **Save Rule**

### CI/CD Workflows

Create `.github/workflows/ci.yml`:

```yaml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install
        run: npm ci
      
      - name: Test
        run: npm test
      
      - name: Build
        run: npm run build
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dist
          path: dist/
```

---

## üêõ Troubleshooting

### Common Issues

**"Rate limit exceeded" on login:**
- Default: 5 attempts per 15 minutes
- Solution: Wait 15 minutes or adjust `RATE_LIMIT_AUTH` in `.env`

**"CSRF token validation failed":**
- Ensure cookies are enabled
- Check `SITE_URL` matches your actual domain
- Verify HTTPS in production

**"Unauthorized" on git hooks:**
- Check `INTERNAL_HOOK_SECRET` is set
- Verify hooks have correct secret in curl headers
- Re-run `git init` on repositories to reinstall hooks

**Database connection errors:**
- Verify `DATABASE_URL` format
- Check database server is running
- Ensure user has correct permissions

**Storage upload fails:**
- Test connection in `/admin/storage`
- Verify S3 credentials and bucket permissions
- Check firewall rules for external storage

### Debug Mode

```env
# Enable detailed logging
LOG_LEVEL=debug
NODE_ENV=development

# View logs
tail -f data/logs/opencodehub.log
```

### Health Check

```bash
curl http://localhost:3000/api/health

# Response:
{
  "status": "ok",
  "checks": {
    "database": "ok",
    "storage": "ok",
    "redis": "ok" // if configured
  },
  "uptime": 123456,
  "version": "1.0.0"
}
```

---

## ü§ù Contributing

We welcome contributions! See [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines.

### Development Setup

```bash
# Fork and clone
git clone https://github.com/swadhinbiswas/OpencodeHub.git
cd OpencodeHub

# Install dependencies
bun install

# Run in development
bun run dev

# Run tests
bun test

# Lint
bun run lint
```

### Submitting Changes

1. Create a feature branch (`git checkout -b feature/amazing-feature`)
2. Make your changes
3. Add tests
4. Run `bun test` and `bun run lint`
5. Commit (`git commit -m 'Add amazing feature'`)
6. Push (`git push origin feature/amazing-feature`)
7. Open a Pull Request

---

## üìÑ License

MIT License - see [LICENSE](LICENSE) for details.

---

## üôè Acknowledgments

- [Astro](https://astro.build/) - Web framework
- [shadcn/ui](https://ui.shadcn.com/) - UI components
- [Drizzle ORM](https://orm.drizzle.team/) - Database toolkit
- [simple-git](https://github.com/steveukx/git-js) - Git operations
- [Monaco Editor](https://microsoft.github.io/monaco-editor/) - Code editor
- [Zod](https://zod.dev/) - Schema validation

---

<p align="center">
  <strong>Made with ‚ù§Ô∏è for the open source community</strong>
  <br>
  <a href="https://github.com/swadhinbiswas/OpencodeHub/issues">Report Bug</a> ‚Ä¢
  <a href="https://github.com/swadhinbiswas/OpencodeHub/issues">Request Feature</a>
</p>
