---
import {
  Code,
  FileText,
  Settings,
  Shield,
  BarChart2,
  GitPullRequest,
  Layout,
  PlayCircle,
  Book,
} from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { RepoActions } from "@/components/repo/RepoActions";

interface Props {
  repo: {
    owner: string;
    name: string;
    description?: string | null;
    visibility: string;
    topics?: string[];
    watchers?: number;
    forks?: number;
    stars?: number;
    openIssueCount?: number;
    openPrCount?: number;
    website?: string | null;
    license?: string | null;
    updatedAt?: Date | string | number | null;
  };
  activeTab:
    | "code"
    | "issues"
    | "pulls"
    | "actions"
    | "projects"
    | "wiki"
    | "security"
    | "insights"
    | "settings";
}

const { repo, activeTab } = Astro.props;
const isLoggedIn = !!Astro.locals.user;

// Helper for time ago
function timeAgo(date: Date | string | number) {
  if (!date) return "";
  const seconds = Math.floor(
    (new Date().getTime() - new Date(date).getTime()) / 1000,
  );
  let interval = seconds / 31536000;
  if (interval > 1) return Math.floor(interval) + "y ago";
  interval = seconds / 2592000;
  if (interval > 1) return Math.floor(interval) + "mo ago";
  interval = seconds / 86400;
  if (interval > 1) return Math.floor(interval) + "d ago";
  interval = seconds / 3600;
  if (interval > 1) return Math.floor(interval) + "h ago";
  interval = seconds / 60;
  if (interval > 1) return Math.floor(interval) + "m ago";
  return Math.floor(seconds) + "s ago";
}

const tabs = [
  {
    id: "code",
    label: "Code",
    icon: Code,
    href: `/${repo.owner}/${repo.name}`,
  },
  {
    id: "issues",
    label: "Issues",
    icon: FileText,
    href: `/${repo.owner}/${repo.name}/issues`,
    count: repo.openIssueCount,
  },
  {
    id: "pulls",
    label: "Pull Requests",
    icon: GitPullRequest,
    href: `/${repo.owner}/${repo.name}/pulls`,
    count: repo.openPrCount,
  },
  {
    id: "actions",
    label: "Actions",
    icon: PlayCircle,
    href: `/${repo.owner}/${repo.name}/actions`,
  },
  {
    id: "projects",
    label: "Projects",
    icon: Layout,
    href: `/${repo.owner}/${repo.name}/projects`,
  },
  {
    id: "wiki",
    label: "Wiki",
    icon: Book,
    href: `/${repo.owner}/${repo.name}/wiki`,
  },
  {
    id: "security",
    label: "Security",
    icon: Shield,
    href: `/${repo.owner}/${repo.name}/security`,
  },
  {
    id: "insights",
    label: "Insights",
    icon: BarChart2,
    href: `/${repo.owner}/${repo.name}/insights`,
  },
  {
    id: "settings",
    label: "Settings",
    icon: Settings,
    href: `/${repo.owner}/${repo.name}/settings`,
  },
];
---

<div class="mb-6">
  <!-- Top Section: Repo Name & Action Buttons -->
  <div
    class="flex flex-col lg:flex-row lg:items-start justify-between gap-4 py-8 border-b"
  >
    <!-- Repo Info -->
    <div class="space-y-4 max-w-3xl">
      <!-- Repo Name -->
      <div class="flex items-center gap-3 flex-wrap">
        <a
          href={`/${repo.owner}`}
          class="text-xl text-muted-foreground hover:text-foreground hover:underline transition-colors"
        >
          {repo.owner}
        </a>
        <span class="text-xl text-muted-foreground">/</span>
        <a
          href={`/${repo.owner}/${repo.name}`}
          class="text-xl font-bold hover:text-primary hover:underline transition-colors"
        >
          {repo.name}
        </a>
        <Badge
          variant="secondary"
          className="rounded-full px-2.5 font-normal text-muted-foreground border-muted-foreground/30"
        >
          {repo.visibility}
        </Badge>
      </div>

      <!-- Description -->
      {
        repo.description && (
          <p class="text-base text-foreground/80 leading-relaxed">
            {repo.description}
          </p>
        )
      }

      <!-- Metadata Row -->
      <div
        class="flex flex-wrap items-center gap-x-6 gap-y-2 text-sm text-muted-foreground"
      >
        {
          repo.website && (
            <a
              href={repo.website}
              target="_blank"
              rel="noopener noreferrer"
              class="flex items-center gap-1.5 hover:text-primary transition-colors"
            >
              <svg
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
                />
              </svg>
              {repo.website}
            </a>
          )
        }
        {
          repo.license && (
            <div class="flex items-center gap-1.5">
              <svg
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"
                />
              </svg>
              {repo.license} license
            </div>
          )
        }
        {repo.updatedAt && <div>Updated {timeAgo(repo.updatedAt)}</div>}
      </div>

      <!-- Topics -->
      {
        repo.topics && repo.topics.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {repo.topics.map((topic: string) => (
              <Badge
                variant="secondary"
                className="rounded-full hover:bg-primary/20 hover:text-primary cursor-pointer transition-colors"
              >
                <a href={`/topics/${topic}`}>{topic}</a>
              </Badge>
            ))}
          </div>
        )
      }
    </div>

    <!-- Action Buttons -->
    <RepoActions
      client:load
      owner={repo.owner}
      repo={repo.name}
      watchers={repo.watchers || 0}
      forks={repo.forks || 0}
      stars={repo.stars || 0}
      isLoggedIn={isLoggedIn}
    />
  </div>

  <!-- Navigation Tabs -->
  <div class="overflow-x-auto -mx-4 px-4 pt-4">
    <nav class="flex gap-1 min-w-max border-b border-transparent">
      {
        tabs.map((tab) => (
          <a
            href={tab.href}
            class:list={[
              "inline-flex items-center gap-2 px-4 py-2.5 rounded-t-lg text-sm font-medium border-b-2 transition-all",
              activeTab === tab.id
                ? "border-primary text-foreground bg-muted/40"
                : "border-transparent text-muted-foreground hover:text-foreground hover:border-muted-foreground/30",
            ]}
          >
            <tab.icon className="h-4 w-4" />
            {tab.label}
            {tab.count !== undefined && tab.count > 0 && (
              <span
                class:list={[
                  "rounded-full px-2 py-0.5 text-xs font-medium",
                  activeTab === tab.id
                    ? "bg-primary/10 text-primary"
                    : "bg-muted text-muted-foreground",
                ]}
              >
                {tab.count}
              </span>
            )}
          </a>
        ))
      }
    </nav>
  </div>
</div>
