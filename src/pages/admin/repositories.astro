---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { getDatabase, schema } from "@/db";
import { desc, eq, like, or, sql } from "drizzle-orm";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { GitBranch, Trash2, Archive, Search, ChevronLeft, ChevronRight } from "lucide-react";

const user = Astro.locals.user;
if (!user?.isAdmin) return Astro.redirect('/');

const db = getDatabase();
const searchQuery = Astro.url.searchParams.get('q') || '';
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const limit = 20;
const offset = (page - 1) * limit;

// Conditions
let whereClause = undefined;
if (searchQuery) {
    whereClause = or(
        like(schema.repositories.name, `%${searchQuery}%`),
        like(schema.repositories.description, `%${searchQuery}%`)
    );
}

// Fetch
const [repos, totalResult] = await Promise.all([
    db.query.repositories.findMany({
        where: whereClause,
        orderBy: [desc(schema.repositories.createdAt)],
        limit,
        offset,
        with: {
            owner: true
        }
    }),
    db.select({ count: sql<number>`count(*)` })
        .from(schema.repositories)
        .where(whereClause)
        .get()
]);

const total = totalResult?.count || 0;
const totalPages = Math.ceil(total / limit);
---

<AdminLayout title="Repository Management">
  <div class="min-h-screen bg-background p-6">
    <div class="max-w-7xl mx-auto space-y-6">
      
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold flex items-center gap-2">
            <GitBranch class="h-6 w-6" />
            Repositories
          </h1>
          <p class="text-muted-foreground">Manage system repositories</p>
        </div>
        <a href="/admin" class="text-muted-foreground hover:text-foreground">
          ‚Üê Back to Dashboard
        </a>
      </div>

       {/* Search */}
       <form method="GET" class="flex gap-2">
        <div class="relative flex-1">
          <Search class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
          <Input 
            name="q" 
            value={searchQuery}
            placeholder="Search repositories..."
            class="pl-10"
          />
        </div>
        <Button type="submit">Search</Button>
      </form>

      <Card>
        <CardHeader>
            <CardTitle>All Repositories ({total})</CardTitle>
        </CardHeader>
        <CardContent>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left p-3 text-sm font-medium text-muted-foreground">Name</th>
                            <th class="text-left p-3 text-sm font-medium text-muted-foreground">Owner</th>
                            <th class="text-left p-3 text-sm font-medium text-muted-foreground">Visibility</th>
                            <th class="text-left p-3 text-sm font-medium text-muted-foreground">Created</th>
                            <th class="text-right p-3 text-sm font-medium text-muted-foreground">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {repos.map(r => (
                            <tr class="border-b hover:bg-muted/50">
                                <td class="p-3">
                                    <div class="font-medium">{r.name}</div>
                                    <div class="text-xs text-muted-foreground truncate max-w-[200px]">{r.description}</div>
                                </td>
                                <td class="p-3">
                                    <div class="flex items-center gap-2">
                                        <div class="text-sm">{r.owner.username}</div>
                                    </div>
                                </td>
                                <td class="p-3">
                                    <span class={`text-xs px-2 py-1 rounded ${r.visibility === 'private' ? 'bg-red-500/10 text-red-500' : 'bg-green-500/10 text-green-500'}`}>
                                        {r.visibility}
                                    </span>
                                </td>
                                <td class="p-3 text-sm text-muted-foreground">
                                    {new Date(r.createdAt).toLocaleDateString()}
                                </td>
                                <td class="p-3 text-right">
                                    <div class="flex justify-end gap-2">
                                        <Button size="sm" variant="outline" class="h-8 w-8 p-0" title="Archive (Not Implemented)">
                                            <Archive class="h-4 w-4" />
                                        </Button>
                                        <Button size="sm" variant="destructive" class="h-8 w-8 p-0" title="Delete">
                                            <Trash2 class="h-4 w-4" />
                                        </Button>
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

             {/* Pagination */}
             {totalPages > 1 && (
                <div class="flex items-center justify-between mt-4 pt-4 border-t">
                  <div class="text-sm text-muted-foreground">
                    Page {page} of {totalPages}
                  </div>
                  <div class="flex items-center gap-2">
                    {page > 1 && (
                      <a href={`/admin/repositories?page=${page - 1}${searchQuery ? `&q=${searchQuery}` : ''}`}>
                        <Button variant="outline" size="sm"><ChevronLeft class="h-4 w-4" /></Button>
                      </a>
                    )}
                    {page < totalPages && (
                      <a href={`/admin/repositories?page=${page + 1}${searchQuery ? `&q=${searchQuery}` : ''}`}>
                        <Button variant="outline" size="sm"><ChevronRight class="h-4 w-4" /></Button>
                      </a>
                    )}
                  </div>
                </div>
              )}
        </CardContent>
      </Card>
      
    </div>
  </div>
</AdminLayout>
