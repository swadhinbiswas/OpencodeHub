---
import BaseLayout from "@/layouts/BaseLayout.astro";
import RepoHeader from "@/components/repo/RepoHeader.astro";
import { getDatabase, schema } from "@/db";
import { eq, and } from "drizzle-orm";
import { canWriteRepo } from "@/lib/permissions";
import { Plus, CheckCircle2, XCircle, AlertCircle, MoreVertical } from "lucide-react";

const { owner: ownerName, repo: repoName } = Astro.params;
const db = getDatabase();

// Fetch repo & user
const user = await db.query.users.findFirst({
  where: eq(schema.users.username, ownerName!),
});
if (!user) return Astro.redirect("/404");

const repoData = await db.query.repositories.findFirst({
  where: and(
    eq(schema.repositories.ownerId, user.id),
    eq(schema.repositories.name, repoName!)
  ),
  with: { owner: true }
});
if (!repoData) return Astro.redirect("/404");

// Check permissions
const currentUser = Astro.locals.user;
if (!await canWriteRepo(currentUser?.id, repoData)) return Astro.redirect("/403");

// Fetch Webhooks
const webhooks = await db.query.webhooks.findMany({
    where: eq(schema.webhooks.repositoryId, repoData.id),
    orderBy: (hooks, { desc }) => [desc(hooks.createdAt)],
});

const repo = {
  id: repoData.id,
  owner: repoData.owner.username,
  name: repoData.name,
  description: repoData.description,
  visibility: repoData.visibility,
  defaultBranch: repoData.defaultBranch,
  stars: repoData.starCount,
  forks: repoData.forkCount,
  watchers: repoData.watchCount,
  language: repoData.language || "Unknown",
  license: repoData.licenseType || "None",
  topics: repoData.topics ? JSON.parse(repoData.topics) : [],
  updatedAt: repoData.updatedAt,
  httpCloneUrl: repoData.httpCloneUrl,
  sshCloneUrl: repoData.sshCloneUrl,
  openIssueCount: repoData.openIssueCount,
  openPrCount: repoData.openPrCount,
};
---

<BaseLayout title={`Webhooks - ${repo.owner}/${repo.name}`}>
    <div class="container py-6">
        <RepoHeader repo={repo} activeTab="settings" />

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mt-6">
            <!-- Settings Sidebar -->
            <div class="space-y-1">
                <a href={`/${repo.owner}/${repo.name}/settings`} class="block px-3 py-2 rounded-md text-sm font-medium text-muted-foreground hover:bg-accent hover:text-accent-foreground">
                    General
                </a>
                <a href={`/${repo.owner}/${repo.name}/settings/collaborators`} class="block px-3 py-2 rounded-md text-sm font-medium text-muted-foreground hover:bg-accent hover:text-accent-foreground">
                    Collaborators
                </a>
                <a href={`/${repo.owner}/${repo.name}/settings/webhooks`} class="block px-3 py-2 rounded-md text-sm font-medium bg-secondary text-secondary-foreground">
                    Webhooks
                </a>
                <a href={`/${repo.owner}/${repo.name}/settings/actions`} class="block px-3 py-2 rounded-md text-sm font-medium text-muted-foreground hover:bg-accent hover:text-accent-foreground">
                    Actions
                </a>
                 <a href={`/${repo.owner}/${repo.name}/settings/deploy_keys`} class="block px-3 py-2 rounded-md text-sm font-medium text-muted-foreground hover:bg-accent hover:text-accent-foreground">
                    Deploy Keys
                </a>
            </div>

            <!-- Content -->
            <div class="lg:col-span-3 space-y-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-semibold tracking-tight">Webhooks</h2>
                        <p class="text-sm text-muted-foreground">
                            Webhooks allow external services to be notified when certain events happen.
                        </p>
                    </div>
                    <a href={`/${repo.owner}/${repo.name}/settings/webhooks/new`} class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90">
                        <Plus className="h-4 w-4" />
                        Add Webhook
                    </a>
                </div>

                <div class="border rounded-lg divide-y">
                    {webhooks.length === 0 ? (
                        <div class="p-12 text-center text-muted-foreground">
                            <p>No webhooks configured yet.</p>
                        </div>
                    ) : (
                        webhooks.map(hook => (
                            <div class="p-4 flex items-center justify-between hover:bg-muted/50 transition-colors">
                                <div class="flex items-start gap-3">
                                    <div class="mt-1">
                                        {hook.lastDeliveryStatus === 'success' ? (
                                            <CheckCircle2 className="h-5 w-5 text-green-500" />
                                        ) : hook.lastDeliveryStatus === 'failure' ? (
                                            <XCircle className="h-5 w-5 text-red-500" />
                                        ) : (
                                            <div class="h-5 w-5 rounded-full border-2 border-muted-foreground/30"></div>
                                        )}
                                    </div>
                                    <div class="space-y-1">
                                        <div class="flex items-center gap-2">
                                            <a href={`/${repo.owner}/${repo.name}/settings/webhooks/${hook.id}`} class="font-medium hover:underline">
                                                {hook.url}
                                            </a>
                                            {!hook.isActive && (
                                                <span class="px-2 py-0.5 rounded-full bg-muted text-muted-foreground text-xs">Disabled</span>
                                            )}
                                        </div>
                                        <div class="text-sm text-muted-foreground flex items-center gap-2">
                                            {/* Safely access events property */}
                                            <span>
                                                {(() => {
                                                    try {
                                                        const events = Array.isArray(hook.events) ? hook.events : JSON.parse(hook.events as any);
                                                        return events.includes('*') 
                                                            ? 'All events' 
                                                            : `${events.length} event${events.length === 1 ? '' : 's'}`;
                                                    } catch (e) {
                                                        return 'Invalid configuration';
                                                    }
                                                })()}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <a href={`/${repo.owner}/${repo.name}/settings/webhooks/${hook.id}/edit`} class="text-sm font-medium text-muted-foreground hover:text-foreground">
                                        Edit
                                    </a>
                                    <button 
                                        class="text-sm font-medium text-red-500 hover:text-red-600 delete-webhook"
                                        data-id={hook.id}
                                    >
                                        Delete
                                    </button>
                                </div>
                            </div>
                        ))
                    )}
                </div>
            </div>
        </div>
    </div>
</BaseLayout>

<script define:vars={{ repoId: repo.id }}>
    document.querySelectorAll('.delete-webhook').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            if (!confirm('Are you sure you want to delete this webhook?')) return;
            
            const id = e.target.dataset.id;
            try {
                const res = await fetch(`/api/repos/${repoId}/webhooks/${id}`, {
                    method: 'DELETE'
                });
                if (res.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to delete webhook');
                }
            } catch (err) {
                alert('Error deleting webhook');
            }
        });
    });
</script>
