---
import BaseLayout from "@/layouts/BaseLayout.astro";
import RepoHeader from "@/components/repo/RepoHeader.astro";
import { getDatabase, schema } from "@/db";
import { eq, and, desc } from "drizzle-orm";
import { canWriteRepo } from "@/lib/permissions";
import { ArrowLeft, CheckCircle2, XCircle, Clock } from "lucide-react";

const { owner: ownerName, repo: repoName, id } = Astro.params;
const db = getDatabase();

// Fetch repo & user
const user = await db.query.users.findFirst({
  where: eq(schema.users.username, ownerName!),
});
if (!user) return Astro.redirect("/404");

const repoData = await db.query.repositories.findFirst({
  where: and(
    eq(schema.repositories.ownerId, user.id),
    eq(schema.repositories.name, repoName!)
  ),
  with: { owner: true }
});
if (!repoData) return Astro.redirect("/404");

// Check permissions
const currentUser = Astro.locals.user;
if (!await canWriteRepo(currentUser?.id, repoData)) return Astro.redirect("/403");

// Fetch Webhook
const webhook = await db.query.webhooks.findFirst({
    where: and(
        eq(schema.webhooks.id, id!),
        eq(schema.webhooks.repositoryId, repoData.id)
    ),
    with: {
        deliveries: {
            orderBy: (deliveries, { desc }) => [desc(deliveries.createdAt)],
            limit: 50,
        }
    }
});

if (!webhook) return Astro.redirect("/404");

const repo = {
  id: repoData.id,
  owner: repoData.owner.username,
  name: repoData.name,
  description: repoData.description,
  visibility: repoData.visibility,
  defaultBranch: repoData.defaultBranch,
  stars: repoData.starCount,
  forks: repoData.forkCount,
  watchers: repoData.watchCount,
  language: repoData.language || "Unknown",
  license: repoData.licenseType || "None",
  topics: repoData.topics ? JSON.parse(repoData.topics) : [],
  updatedAt: repoData.updatedAt,
  httpCloneUrl: repoData.httpCloneUrl,
  sshCloneUrl: repoData.sshCloneUrl,
  openIssueCount: repoData.openIssueCount,
  openPrCount: repoData.openPrCount,
};
---

<BaseLayout title={`Webhook ${id} - ${repo.owner}/${repo.name}`}>
    <div class="container py-6">
        <RepoHeader repo={repo} activeTab="settings" />

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mt-6">
            <!-- Settings Sidebar -->
            <div class="space-y-1">
                <a href={`/${repo.owner}/${repo.name}/settings`} class="block px-3 py-2 rounded-md text-sm font-medium text-muted-foreground hover:bg-accent hover:text-accent-foreground">
                    General
                </a>
                 <a href={`/${repo.owner}/${repo.name}/settings/collaborators`} class="block px-3 py-2 rounded-md text-sm font-medium text-muted-foreground hover:bg-accent hover:text-accent-foreground">
                    Collaborators
                </a>
                <a href={`/${repo.owner}/${repo.name}/settings/webhooks`} class="block px-3 py-2 rounded-md text-sm font-medium bg-secondary text-secondary-foreground">
                    Webhooks
                </a>
                 <a href={`/${repo.owner}/${repo.name}/settings/actions`} class="block px-3 py-2 rounded-md text-sm font-medium text-muted-foreground hover:bg-accent hover:text-accent-foreground">
                    Actions
                </a>
                 <a href={`/${repo.owner}/${repo.name}/settings/deploy_keys`} class="block px-3 py-2 rounded-md text-sm font-medium text-muted-foreground hover:bg-accent hover:text-accent-foreground">
                    Deploy Keys
                </a>
            </div>

            <!-- Content -->
            <div class="lg:col-span-3 space-y-6">
                 <div>
                    <a href={`/${repo.owner}/${repo.name}/settings/webhooks`} class="inline-flex items-center text-sm text-muted-foreground hover:text-foreground mb-4">
                        <ArrowLeft className="h-4 w-4 mr-1" />
                        Back to Webhooks
                    </a>
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-semibold tracking-tight truncate max-w-xl" title={webhook.url}>
                            {webhook.url}
                        </h2>
                        <div class="flex gap-2">
                             <a href={`/${repo.owner}/${repo.name}/settings/webhooks/${webhook.id}/edit`} class="inline-flex items-center justify-center rounded-md text-sm font-medium border border-input bg-background h-9 px-4 py-2 hover:bg-accent hover:text-accent-foreground">
                                Edit
                            </a>
                            <button id="delete-webhook" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-red-600 text-white h-9 px-4 py-2 hover:bg-red-700">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>

                <div class="border rounded-lg bg-card text-card-foreground shadow-sm">
                    <div class="p-6">
                        <h3 class="font-semibold mb-4">Recent Deliveries</h3>
                        
                        <div class="divide-y max-h-[600px] overflow-y-auto">
                            {webhook.deliveries.length === 0 ? (
                                <p class="text-muted-foreground text-sm py-4 text-center">No deliveries yet.</p>
                            ) : (
                                webhook.deliveries.map(delivery => (
                                    <div class="py-3 flex items-start gap-3">
                                        <div class="mt-1">
                                             {delivery.status === 'success' ? (
                                                <CheckCircle2 className="h-5 w-5 text-green-500" />
                                            ) : (
                                                <XCircle className="h-5 w-5 text-red-500" />
                                            )}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center justify-between">
                                                <span class="font-mono text-sm font-medium">{delivery.event}</span>
                                                <span class="text-xs text-muted-foreground">{new Date(delivery.createdAt).toLocaleString()}</span>
                                            </div>
                                            <div class="flex items-center gap-2 mt-1 text-sm text-muted-foreground">
                                                <span class={`font-mono px-1.5 py-0.5 rounded text-xs ${delivery.status === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                    {delivery.responseCode}
                                                </span>
                                                <span class="flex items-center gap-1">
                                                    <Clock className="h-3 w-3" />
                                                    {delivery.durationMs}ms
                                                </span>
                                                <span class="truncate max-w-[200px]">{delivery.id}</span>
                                            </div>
                                            {/* Expandable Details */}
                                            <details class="mt-2 group">
                                                <summary class="text-xs text-primary cursor-pointer hover:underline list-none">View Details</summary>
                                                <div class="mt-2 p-3 bg-muted rounded-md text-xs font-mono overflow-x-auto space-y-2">
                                                    <div>
                                                        <div class="font-semibold text-muted-foreground mb-1">Request Headers</div>
                                                        <pre>{JSON.stringify(delivery.requestHeaders, null, 2)}</pre>
                                                    </div>
                                                    <div>
                                                        <div class="font-semibold text-muted-foreground mb-1">Payload</div>
                                                        <pre>{JSON.stringify(delivery.payload, null, 2)}</pre>
                                                    </div>
                                                    <div>
                                                        <div class="font-semibold text-muted-foreground mb-1">Response Body</div>
                                                        <pre>{delivery.responseBody}</pre>
                                                    </div>
                                                </div>
                                            </details>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</BaseLayout>

<script define:vars={{ repoId: repo.id, owner: repo.owner, repoName: repo.name, webhookId: webhook.id }}>
    document.getElementById('delete-webhook').addEventListener('click', async () => {
        if (!confirm('Are you sure you want to delete this webhook?')) return;
        
        try {
            const res = await fetch(`/api/repos/${repoId}/webhooks/${webhookId}`, {
                method: 'DELETE'
            });
            if (res.ok) {
                window.location.href = `/${owner}/${repoName}/settings/webhooks`;
            } else {
                alert('Failed to delete webhook');
            }
        } catch (err) {
            alert('Error deleting webhook');
        }
    });
</script>
