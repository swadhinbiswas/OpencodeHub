---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
  CardFooter,
} from "@/components/ui/card";
import { getDatabase, schema } from "@/db";
import { eq, and } from "drizzle-orm";
import { canAdminRepo } from "@/lib/permissions";
import RepoHeader from "@/components/repo/RepoHeader.astro";
import RepoSettings from "@/components/repo/RepoSettings";

const { owner: ownerName, repo: repoName } = Astro.params;
const db = getDatabase();

// 1. Fetch Repo & Owner
const user = await db.query.users.findFirst({
  where: eq(schema.users.username, ownerName!),
});

if (!user) return Astro.redirect("/404");

const repoData = await db.query.repositories.findFirst({
  where: and(
    eq(schema.repositories.ownerId, user.id),
    eq(schema.repositories.name, repoName!),
  ),
  with: {
    owner: true,
  },
});

if (!repoData) return Astro.redirect("/404");

// Check permissions
const currentUser = Astro.locals.user;
const hasAccess = await canAdminRepo(currentUser?.id, repoData, {
  isAdmin: currentUser?.isAdmin ?? undefined,
});

if (!hasAccess) {
  console.log(
    `[Settings] Access denied for user ${currentUser?.id} to repo owned by ${repoData.ownerId}. hasAccess=${hasAccess}`,
  );
  return Astro.redirect(`/${ownerName}/${repoName}`);
}

const repo = {
  owner: repoData.owner.username,
  name: repoData.name,
  description: repoData.description || undefined,
  visibility: repoData.visibility as "public" | "private" | "internal",
  defaultBranch: repoData.defaultBranch,
  stars: repoData.starCount,
  forks: repoData.forkCount,
  watchers: repoData.watchCount,
  language: repoData.language || "Unknown",
  license: repoData.licenseType || "None",
  topics: repoData.topics ? JSON.parse(repoData.topics) : [],
  updatedAt: repoData.updatedAt,
  httpCloneUrl: repoData.httpCloneUrl,
  sshCloneUrl: repoData.sshCloneUrl,
  openIssueCount: repoData.openIssueCount,
  openPrCount: repoData.openPrCount,
  hasIssues: repoData.hasIssues ?? false,
  hasWiki: repoData.hasWiki ?? false,
  hasActions: repoData.hasActions ?? false,
  isArchived: repoData.isArchived ?? false,
  isTemplate: repoData.isTemplate ?? false,
};
---

<BaseLayout title={`Settings Â· ${repo.owner}/${repo.name}`}>
  <div class="container py-6">
    <RepoHeader repo={repo} activeTab="settings" />

    <div class="grid gap-6 md:grid-cols-[240px_1fr]">
      <!-- Settings Sidebar -->
      <nav class="space-y-1">
        <a
          href={`/${repo.owner}/${repo.name}/settings`}
          class="flex items-center gap-2 rounded-md bg-muted px-3 py-2 text-sm font-medium text-foreground"
        >
          General
        </a>
        <a
          href={`/${repo.owner}/${repo.name}/settings/collaborators`}
          class="flex items-center gap-2 rounded-md px-3 py-2 text-sm font-medium text-muted-foreground hover:bg-muted hover:text-foreground"
        >
          Collaborators
        </a>
        <a
          href={`/${repo.owner}/${repo.name}/settings/webhooks`}
          class="flex items-center gap-2 rounded-md px-3 py-2 text-sm font-medium text-muted-foreground hover:bg-muted hover:text-foreground"
        >
          Webhooks
        </a>
        <a
          href={`/${repo.owner}/${repo.name}/settings/external-ci`}
          class="flex items-center gap-2 rounded-md px-3 py-2 text-sm font-medium text-muted-foreground hover:bg-muted hover:text-foreground"
        >
          External CI
        </a>
        <a
          href={`/${repo.owner}/${repo.name}/settings/reviews`}
          class="flex items-center gap-2 rounded-md px-3 py-2 text-sm font-medium text-muted-foreground hover:bg-muted hover:text-foreground"
        >
          Reviews
        </a>
        <a
          href={`/${repo.owner}/${repo.name}/settings/actions`}
          class="flex items-center gap-2 rounded-md px-3 py-2 text-sm font-medium text-muted-foreground hover:bg-muted hover:text-foreground"
        >
          Actions
        </a>
        <a
          href={`/${repo.owner}/${repo.name}/settings/deploy-keys`}
          class="flex items-center gap-2 rounded-md px-3 py-2 text-sm font-medium text-muted-foreground hover:bg-muted hover:text-foreground"
        >
          Deploy keys
        </a>
        <a
          href={`/${repo.owner}/${repo.name}/settings/workflow`}
          class="flex items-center gap-2 rounded-md px-3 py-2 text-sm font-medium text-muted-foreground hover:bg-muted hover:text-foreground"
        >
          Workflow
        </a>
      </nav>

      <!-- Settings Content -->
      <RepoSettings client:load repo={repo} />
    </div>
  </div>
</BaseLayout>
