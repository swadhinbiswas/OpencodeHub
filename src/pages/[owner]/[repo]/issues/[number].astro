---
import RepoHeader from "@/components/repo/RepoHeader.astro";
import IssueDetail from "@/components/issues/IssueDetail";
import { getDatabase, schema } from "@/db";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { renderMarkdown } from "@/lib/markdown";
import { and, eq } from "drizzle-orm";

const { owner: ownerName, repo: repoName, number } = Astro.params;
const db = getDatabase();

// 1. Fetch Repo & Owner
const user = await db.query.users.findFirst({
  where: eq(schema.users.username, ownerName!),
});

if (!user) return Astro.redirect("/404");

const repoData = await db.query.repositories.findFirst({
  where: and(
    eq(schema.repositories.ownerId, user.id),
    eq(schema.repositories.name, repoName!)
  ),
  with: {
    owner: true,
  },
});

if (!repoData) return Astro.redirect("/404");

// 2. Fetch Issue
const issue = await db.query.issues.findFirst({
  where: and(
    eq(schema.issues.repositoryId, repoData.id),
    eq(schema.issues.number, parseInt(number!))
  ),
  with: {
    author: true,
  },
});

if (!issue) return Astro.redirect("/404");

const bodyHtml = await renderMarkdown(issue.body || "");

const repoForHeader = {
  ...repoData,
  owner: repoData.owner.username,
};

// Format issue for React component
const formattedIssue = {
  id: issue.id,
  number: issue.number,
  title: issue.title,
  body: issue.body || "",
  state: issue.state as "open" | "closed",
  createdAt: issue.createdAt,
  author: {
    username: issue.author.username,
    avatarUrl: issue.author.avatarUrl || undefined,
  },
  assignees: [], // TODO: Add assignees when schema supports it
  labels: [], // TODO: Add labels when schema relation is fixed
};
---

<BaseLayout
  title={`${issue.title} · Issue #${issue.number} · ${ownerName}/${repoName}`}
>
  <RepoHeader repo={repoForHeader} activeTab="issues" />

  <div class="container py-8">
    <IssueDetail 
      client:load
      issue={formattedIssue}
      bodyHtml={bodyHtml}
      repoOwner={ownerName!}
      repoName={repoName!}
    />
  </div>
</BaseLayout>
