---
import RepoHeader from "@/components/repo/RepoHeader.astro";
import IssueDetail from "@/components/issues/IssueDetail";
import { getDatabase, schema } from "@/db";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { renderMarkdown } from "@/lib/markdown";
import { canWriteRepo } from "@/lib/permissions";
import { and, eq } from "drizzle-orm";

const { owner: ownerName, repo: repoName, number } = Astro.params;
const db = getDatabase();

// 1. Fetch Repo & Owner
const user = await db.query.users.findFirst({
  where: eq(schema.users.username, ownerName!),
});

if (!user) return Astro.redirect("/404");

const repoData = await db.query.repositories.findFirst({
  where: and(
    eq(schema.repositories.ownerId, user.id),
    eq(schema.repositories.name, repoName!),
  ),
  with: {
    owner: true,
  },
});

if (!repoData) return Astro.redirect("/404");

// 2. Fetch Issue
const issue = await db.query.issues.findFirst({
  where: and(
    eq(schema.issues.repositoryId, repoData.id),
    eq(schema.issues.number, parseInt(number!)),
  ),
  with: {
    author: true,
    parent: true,
    children: true,
    status: true,
  },
});

if (!issue) return Astro.redirect("/404");

const currentUser = Astro.locals.user;
const canLink = await canWriteRepo(currentUser?.id, repoData);

const bodyHtml = await renderMarkdown(issue.body || "");

const repoForHeader = {
  ...repoData,
  owner: repoData.owner.username,
  topics: repoData.topics ? JSON.parse(repoData.topics) : [],
};

// Format issue for React component
const formattedIssue = {
  id: issue.id,
  number: issue.number,
  title: issue.title,
  body: issue.body || "",
  state: issue.state as "open" | "closed",
  status: issue.status
    ? {
        id: issue.status.id,
        name: issue.status.name,
        color: issue.status.color,
        type: issue.status.type,
      }
    : undefined,
  type: issue.type,
  createdAt: issue.createdAt.toISOString(),
  author: {
    username: issue.author.username,
    avatarUrl: issue.author.avatarUrl || undefined,
  },
  assignees: [], // TODO: Add assignees when schema supports it
  labels: [], // TODO: Add labels when schema relation is fixed
  parent: issue.parent
    ? {
        number: issue.parent.number,
        title: issue.parent.title,
        state: issue.parent.state as "open" | "closed",
      }
    : undefined,
  children: issue.children.map((child) => ({
    number: child.number,
    title: child.title,
    state: child.state as "open" | "closed",
  })),
};
---

<BaseLayout
  title={`${issue.title} Â· Issue #${issue.number} Â· ${ownerName}/${repoName}`}
>
  <RepoHeader repo={repoForHeader} activeTab="issues" />

  <div class="container py-8">
    <IssueDetail
      client:load
      issue={formattedIssue}
      bodyHtml={bodyHtml}
      repoOwner={ownerName!}
      repoName={repoName!}
      canLink={canLink}
    />
  </div>
</BaseLayout>
