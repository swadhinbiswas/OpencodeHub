---
import BaseLayout from "@/layouts/BaseLayout.astro";
import RepoHeader from "@/components/repo/RepoHeader.astro";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";

import { getDatabase, schema } from "@/db";
import { eq, and } from "drizzle-orm";

const { owner: ownerName, repo: repoName } = Astro.params;
const db = getDatabase();

// 1. Fetch Repo & Owner
const user = await db.query.users.findFirst({
  where: eq(schema.users.username, ownerName!),
});

if (!user) return Astro.redirect("/404");

const repoData = await db.query.repositories.findFirst({
  where: and(
    eq(schema.repositories.ownerId, user.id),
    eq(schema.repositories.name, repoName!),
  ),
  with: {
    owner: true,
  },
});

if (!repoData) return Astro.redirect("/404");

// Check auth
const currentUser = Astro.locals.user;
if (!currentUser) {
  return Astro.redirect(`/login?redirect=${Astro.url.pathname}`);
}

// TODO: Check permissions (can user create issue?)

const repoForHeader = {
  ...repoData,
  owner: repoData.owner.username,
  topics: repoData.topics ? JSON.parse(repoData.topics) : [],
};

// Fetch custom fields
const customFields = await db.query.customFieldDefinitions.findMany({
  where: eq(schema.customFieldDefinitions.repositoryId, repoData.id),
  orderBy: [schema.customFieldDefinitions.createdAt], // Default sort
});
---

<BaseLayout title={`New Issue · ${ownerName}/${repoName}`}>
  <RepoHeader repo={repoForHeader} activeTab="issues" />

  <div class="container max-w-4xl py-8">
    <div class="mb-6">
      <h1 class="text-2xl font-semibold">New Issue</h1>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-[1fr_300px] gap-8">
      <div class="space-y-6">
        <form id="create-issue-form" class="space-y-4">
          <div class="space-y-2">
            <Input
              id="title"
              name="title"
              placeholder="Title"
              required
              className="text-lg font-medium"
            />
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium">Type</label>
            <div class="relative">
              <select
                name="type"
                class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
              >
                <option value="issue">Issue</option>
                <option value="epic">Epic</option>
                <option value="task">Task</option>
              </select>
            </div>
          </div>

          <div class="space-y-2">
            <Textarea
              id="body"
              name="body"
              placeholder="Leave a comment"
              className="min-h-[200px] font-mono text-sm"
            />
            <p class="text-xs text-muted-foreground">Markdown is supported.</p>
          </div>

          <!-- Custom Fields -->
          {
            customFields.length > 0 && (
              <div class="space-y-4 pt-4 border-t">
                {customFields.map((field) => (
                  <div class="space-y-2">
                    <label class="text-sm font-medium">
                      {field.name}
                      {field.required && (
                        <span class="text-destructive ml-1">*</span>
                      )}
                    </label>

                    {field.type === "text" ||
                    field.type === "number" ||
                    field.type === "date" ? (
                      <Input
                        name={`custom_field_${field.id}`}
                        type={
                          field.type === "number"
                            ? "number"
                            : field.type === "date"
                              ? "date"
                              : "text"
                        }
                        placeholder={field.description || field.name}
                        required={field.required || false}
                      />
                    ) : field.type === "select" ||
                      field.type === "multiselect" ? (
                      <div class="relative">
                        <select
                          name={`custom_field_${field.id}`}
                          required={field.required || false}
                          class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                        >
                          <option value="">Select {field.name}</option>
                          {Array.isArray(field.options) &&
                            field.options.map((opt: string) => (
                              <option value={opt}>{opt}</option>
                            ))}
                        </select>
                      </div>
                    ) : field.type === "boolean" ? (
                      <div class="flex items-center space-x-2">
                        <input
                          type="checkbox"
                          name={`custom_field_${field.id}`}
                          id={`cf_${field.id}`}
                          class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
                        />
                        <label
                          for={`cf_${field.id}`}
                          class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
                        >
                          {field.description || "Yes"}
                        </label>
                      </div>
                    ) : null}
                  </div>
                ))}
              </div>
            )
          }

          <div class="space-y-2">
            <div class="flex justify-end gap-2">
              <Button variant="outline" type="button" id="cancel-btn">
                Cancel
              </Button>
              <Button type="submit" id="submit-btn"> Submit new issue </Button>
            </div>
          </div>
        </form>

        <div class="space-y-6">
          <div class="text-sm text-muted-foreground">
            <h3 class="font-medium text-foreground mb-2">Assignees</h3>
            <p>No one—assign yourself</p>
          </div>
          <div class="text-sm text-muted-foreground">
            <h3 class="font-medium text-foreground mb-2">Labels</h3>
            <p>None yet</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById(
      "create-issue-form",
    ) as HTMLFormElement;
    const submitBtn = document.getElementById(
      "submit-btn",
    ) as HTMLButtonElement;
    const cancelBtn = document.getElementById(
      "cancel-btn",
    ) as HTMLButtonElement;

    cancelBtn?.addEventListener("click", () => {
      window.history.back();
    });

    const urlParams = new URLSearchParams(window.location.search);
    const parentParam = urlParams.get("parent");

    if (parentParam) {
      // Hidden input for parentNumber
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "parentNumber";
      input.value = parentParam;
      form?.appendChild(input);

      // Auto-select "task" type
      const typeSelect = document.querySelector('button[role="combobox"]');
      // Shadcn select is hard to manipulate via plain JS without the component's API
      // We can just forcefully set the hidden select value if present?
      // Actually, Shadcn Select component uses a hidden select or custom structure.
      // The easiest way for now is to just rely on user selecting it, OR assume "task" if parent is present?
      // But we need to send "type: task" to API.
      // Let's just append type=task to formData if not overridden?
      // Or simpler: We can tell the user clearly "Creating sub-task for #123".
    }

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();

      submitBtn.disabled = true;
      const originalText = submitBtn.innerText;
      submitBtn.innerText = "Submitting...";

      try {
        const formData = new FormData(form);
        const data = {
          title: formData.get("title"),
          body: formData.get("body"),
          type: formData.get("type"),
          parentNumber: formData.get("parentNumber"),
          customFields: {},
        };

        // Collect custom fields
        formData.forEach((value, key) => {
          if (key.startsWith("custom_field_")) {
            const fieldId = key.replace("custom_field_", "");
            // @ts-ignore
            if (value) data.customFields[fieldId] = value;
          }
        });

        // Get owner and repo from URL
        const pathParts = window.location.pathname.split("/");
        const owner = pathParts[1];
        const repo = pathParts[2];

        const response = await fetch(`/api/repos/${owner}/${repo}/issues`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.message || "Failed to create issue");
        }

        // Redirect to the new issue
        window.location.href = `/${owner}/${repo}/issues/${result.data.number}`;
      } catch (error) {
        console.error("Error creating issue:", error);
        alert(error instanceof Error ? error.message : "An error occurred");

        submitBtn.disabled = false;
        submitBtn.innerText = originalText;
      }
    });
  </script>
</BaseLayout>
