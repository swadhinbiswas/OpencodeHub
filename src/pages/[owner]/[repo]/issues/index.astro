---
import RepoHeader from "@/components/repo/RepoHeader.astro";
import IssuesList from "@/components/issues/IssuesList";
import { getDatabase, schema } from "@/db";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { canReadRepo } from "@/lib/permissions";
import { and, desc, eq } from "drizzle-orm";

const { owner: ownerName, repo: repoName } = Astro.params;
const db = getDatabase();

// 1. Fetch Repo & Owner
const user = await db.query.users.findFirst({
  where: eq(schema.users.username, ownerName!),
});

if (!user) return Astro.redirect("/404");

const repoData = await db.query.repositories.findFirst({
  where: and(
    eq(schema.repositories.ownerId, user.id),
    eq(schema.repositories.name, repoName!),
  ),
  with: {
    owner: true,
  },
});

if (!repoData) return Astro.redirect("/404");

// Check permissions
const currentUser = Astro.locals.user;
const hasAccess = await canReadRepo(currentUser?.id, repoData);

if (!hasAccess) {
  return Astro.redirect("/404");
}

// 2. Fetch Issues with labels
const issuesList = await db.query.issues.findMany({
  where: eq(schema.issues.repositoryId, repoData.id),
  orderBy: [desc(schema.issues.createdAt)],
  with: {
    author: true,
    labels: {
      with: {
        label: true,
      },
    },
    parent: true,
    children: true,
  },
});

const openCount = issuesList.filter((i) => i.state === "open").length;
const closedCount = issuesList.filter((i) => i.state === "closed").length;

const repo = {
  owner: repoData.owner.username,
  name: repoData.name,
  description: repoData.description,
  visibility: repoData.visibility,
  defaultBranch: repoData.defaultBranch,
  stars: repoData.starCount,
  forks: repoData.forkCount,
  watchers: repoData.watchCount,
  language: repoData.language || "Unknown",
  license: repoData.licenseType || "None",
  topics: repoData.topics ? JSON.parse(repoData.topics) : [],
  updatedAt: repoData.updatedAt,
  httpCloneUrl: repoData.httpCloneUrl,
  sshCloneUrl: repoData.sshCloneUrl,
  openIssueCount: openCount,
  openPrCount: repoData.openPrCount,
};

// Format issues for React component
const formattedIssues = issuesList.map((issue) => ({
  id: issue.id,
  number: issue.number,
  title: issue.title,
  type: issue.type,
  state: issue.state as "open" | "closed",
  createdAt: issue.createdAt.toISOString(),
  commentCount: issue.commentCount || 0,
  author: {
    username: issue.author.username,
    avatarUrl: issue.author.avatarUrl || undefined,
  },
  labels:
    issue.labels?.map((il) => ({
      id: il.label?.id || "",
      name: il.label?.name || "",
      color: il.label?.color || "#6b7280",
    })) || [],
  parent: issue.parent ? {
      number: issue.parent.number,
      title: issue.parent.title,
      state: issue.parent.state as "open" | "closed"
  } : undefined,
  children: issue.children?.map(child => ({
      number: child.number,
      title: child.title,
      state: child.state as "open" | "closed"
  })) || []
}));
---

<BaseLayout title={`Issues Â· ${repo.owner}/${repo.name}`}>
  <div class="container py-6">
    <RepoHeader repo={repo} activeTab="issues" />

    <!-- Enhanced Issues List with Aceternity UI -->
    <div class="mt-6">
      <IssuesList
        client:load
        issues={formattedIssues}
        openCount={openCount}
        closedCount={closedCount}
        repoOwner={repo.owner}
        repoName={repo.name}
      />
    </div>
  </div>
</BaseLayout>
