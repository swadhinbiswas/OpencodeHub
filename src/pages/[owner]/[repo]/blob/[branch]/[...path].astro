---
import RepoHeader from "@/components/repo/RepoHeader.astro";
import { getDatabase, schema } from "@/db";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getFileContent, getLastCommit } from "@/lib/git";
import { renderMarkdown } from "@/lib/markdown";
import { canReadRepo } from "@/lib/permissions";
import { Code } from "astro:components";
import { and, eq, sql } from "drizzle-orm";
import { ChevronRight, Copy, Download, FileText } from "lucide-react";

const { owner: ownerName, repo: repoName, branch, path } = Astro.params;
const db = getDatabase();

// 1. Fetch Repo & Owner
const user = await db.query.users.findFirst({
  where: eq(schema.users.username, ownerName!),
});

if (!user) return Astro.redirect("/404");

const repoData = await db.query.repositories.findFirst({
  where: and(
    eq(schema.repositories.ownerId, user.id),
    eq(schema.repositories.name, repoName!)
  ),
  with: {
    owner: true,
  },
});

if (!repoData) return Astro.redirect("/404");

// Check permissions
const currentUser = Astro.locals.user;
const hasAccess = await canReadRepo(currentUser?.id, repoData);

if (!hasAccess) {
  return Astro.redirect("/404");
}

// Fetch issue count
const issueCountResult = await db
  .select({ count: sql<number>`count(*)` })
  .from(schema.issues)
  .where(
    and(
      eq(schema.issues.repositoryId, repoData.id),
      eq(schema.issues.state, "open")
    )
  )
  .get();

const openIssueCount = issueCountResult?.count || 0;

const currentBranch = branch || repoData.defaultBranch;
const filePath = path || "";

let fileContent: { content: string; isBinary: boolean; size: number } | null =
  null;
let lastCommit: any = null;

try {
  fileContent = await getFileContent(
    repoData.diskPath,
    filePath,
    currentBranch
  );
  lastCommit = await getLastCommit(repoData.diskPath, currentBranch, filePath);
} catch (e) {
  console.error("Git error:", e);
  return Astro.redirect("/404");
}

if (!fileContent) {
  return Astro.redirect("/404");
}

const repo = {
  owner: repoData.owner.username,
  name: repoData.name,
  description: repoData.description,
  visibility: repoData.visibility,
  defaultBranch: repoData.defaultBranch,
  stars: repoData.starCount,
  forks: repoData.forkCount,
  watchers: repoData.watchCount,
  language: repoData.language || "Unknown",
  license: repoData.licenseType || "None",
  topics: repoData.topics ? JSON.parse(repoData.topics) : [],
  updatedAt: repoData.updatedAt,
  httpCloneUrl: repoData.httpCloneUrl,
  sshCloneUrl: repoData.sshCloneUrl,
  openIssueCount: openIssueCount,
  openPrCount: repoData.openPrCount,
};

const breadcrumbs = filePath.split("/");
const fileName = breadcrumbs[breadcrumbs.length - 1];

// Format dates helper
function timeAgo(date: Date | string | number) {
  if (!date) return "";
  const seconds = Math.floor(
    (new Date().getTime() - new Date(date).getTime()) / 1000
  );
  let interval = seconds / 31536000;
  if (interval > 1) return Math.floor(interval) + " years ago";
  interval = seconds / 2592000;
  if (interval > 1) return Math.floor(interval) + " months ago";
  interval = seconds / 86400;
  if (interval > 1) return Math.floor(interval) + " days ago";
  interval = seconds / 3600;
  if (interval > 1) return Math.floor(interval) + " hours ago";
  interval = seconds / 60;
  if (interval > 1) return Math.floor(interval) + " minutes ago";
  return Math.floor(seconds) + " seconds ago";
}

// Size formatter
function formatSize(bytes: number) {
  if (bytes === 0) return "0 B";
  const k = 1024;
  const sizes = ["B", "KB", "MB", "GB", "TB"];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
}

const lineCount = fileContent.isBinary
  ? 0
  : fileContent.content.split("\n").length;

const isMarkdown =
  fileName.toLowerCase().endsWith(".md") ||
  fileName.toLowerCase().endsWith(".markdown");
let renderedMarkdown = "";
if (isMarkdown && !fileContent.isBinary) {
  renderedMarkdown = await renderMarkdown(fileContent.content);
}

function getLanguage(filename: string) {
  const ext = filename.split(".").pop()?.toLowerCase();
  switch (ext) {
    case "js":
      return "javascript";
    case "ts":
      return "typescript";
    case "jsx":
      return "jsx";
    case "tsx":
      return "tsx";
    case "html":
      return "html";
    case "css":
      return "css";
    case "json":
      return "json";
    case "md":
      return "markdown";
    case "py":
      return "python";
    case "go":
      return "go";
    case "rs":
      return "rust";
    case "java":
      return "java";
    case "c":
      return "c";
    case "cpp":
      return "cpp";
    case "h":
      return "c";
    case "hpp":
      return "cpp";
    case "sh":
      return "shell";
    case "yaml":
      return "yaml";
    case "yml":
      return "yaml";
    case "xml":
      return "xml";
    case "sql":
      return "sql";
    case "dockerfile":
      return "dockerfile";
    case "astro":
      return "astro";
    default:
      return "text";
  }
}
---

<BaseLayout title={`${fileName} - ${repo.owner}/${repo.name} - OpenCodeHub`}>
  <div class="container py-6">
    <RepoHeader repo={repo} activeTab="code" />

    <!-- Breadcrumb Navigation -->
    <div class="flex items-center gap-2 text-sm mb-4 mt-4">
      <a
        href={`/${repo.owner}/${repo.name}/tree/${currentBranch}`}
        class="text-primary hover:underline font-medium">{repo.name}</a
      >
      <ChevronRight className="h-4 w-4 text-muted-foreground" />
      {
        breadcrumbs.map((crumb, index) => (
          <>
            {index === breadcrumbs.length - 1 ? (
              <span class="font-bold">{crumb}</span>
            ) : (
              <>
                <a
                  href={`/${repo.owner}/${repo.name}/tree/${currentBranch}/${breadcrumbs.slice(0, index + 1).join("/")}`}
                  class="text-primary hover:underline"
                >
                  {crumb}
                </a>
                <ChevronRight className="h-4 w-4 text-muted-foreground" />
              </>
            )}
          </>
        ))
      }
    </div>

    <div class="rounded-lg border bg-card">
      <!-- File Header -->
      <div
        class="flex items-center justify-between border-b bg-muted/30 px-4 py-3"
      >
        <div class="flex items-center gap-4 text-sm">
          <div class="flex items-center gap-2">
            <div
              class="h-6 w-6 rounded-full bg-muted flex items-center justify-center border"
            >
              <span class="text-xs font-medium"
                >{lastCommit?.authorName?.[0] || "?"}</span
              >
            </div>
            <span class="font-medium"
              >{lastCommit?.authorName || "Unknown"}</span
            >
            <span class="text-muted-foreground"
              >{lastCommit?.message || "No commit message"}</span
            >
          </div>
          <span class="text-muted-foreground text-xs">
            {lastCommit ? timeAgo(lastCommit.authorDate) : ""}
          </span>
        </div>
        <div class="flex items-center gap-2">
          <div class="text-xs text-muted-foreground mr-2">
            {fileContent.isBinary ? "Binary file" : `${lineCount} lines`} Â· {
              formatSize(fileContent.size)
            }
          </div>
          <button
            class="inline-flex items-center justify-center h-8 w-8 rounded-md hover:bg-accent text-muted-foreground hover:text-foreground"
            title="Copy raw file"
          >
            <Copy className="h-4 w-4" />
          </button>
          <a
            href={`/${repo.owner}/${repo.name}/raw/${currentBranch}/${filePath}`}
            class="inline-flex items-center justify-center h-8 w-8 rounded-md hover:bg-accent text-muted-foreground hover:text-foreground"
            title="Download"
          >
            <Download className="h-4 w-4" />
          </a>
        </div>
      </div>

      <!-- File Content -->
      <div class="overflow-x-auto p-0">
        {
          fileContent.isBinary ? (
            <div class="flex flex-col items-center justify-center py-12 text-muted-foreground">
              <FileText className="h-12 w-12 mb-4 opacity-20" />
              <p>Binary file not shown.</p>
              <a
                href={`/${repo.owner}/${repo.name}/raw/${currentBranch}/${filePath}`}
                class="mt-4 text-primary hover:underline text-sm"
              >
                Download file
              </a>
            </div>
          ) : isMarkdown ? (
            <div
              class="p-8 prose dark:prose-invert max-w-none bg-background border-t"
              set:html={renderedMarkdown}
            />
          ) : (
            <div class="text-sm font-mono leading-relaxed overflow-x-auto p-4 bg-[#0d1117]">
              <Code
                code={fileContent.content}
                lang={getLanguage(fileName)}
                theme="github-dark"
              />
            </div>
          )
        }
      </div>
    </div>
  </div>
</BaseLayout>
