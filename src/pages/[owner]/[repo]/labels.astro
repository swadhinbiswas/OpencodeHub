---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getDatabase, schema } from "@/db";
import { eq, and } from "drizzle-orm";
import { canWriteRepo } from "@/lib/permissions";
import RepoHeader from "@/components/repo/RepoHeader.astro";

const { owner: ownerName, repo: repoName } = Astro.params;
const db = getDatabase();

// Fetch Repo & Owner
const user = await db.query.users.findFirst({
  where: eq(schema.users.username, ownerName!),
});

if (!user) return Astro.redirect("/404");

const repoData = await db.query.repositories.findFirst({
  where: and(
    eq(schema.repositories.ownerId, user.id),
    eq(schema.repositories.name, repoName!)
  ),
  with: {
    owner: true,
  },
});

if (!repoData) return Astro.redirect("/404");

// Check permissions
const currentUser = Astro.locals.user;
const canWrite = await canWriteRepo(currentUser?.id, repoData);

if (!canWrite) {
  return Astro.redirect(`/${ownerName}/${repoName}`);
}

// Fetch labels
let labels: any[] = [];
try {
  labels = await db.query.labels.findMany({
    where: eq(schema.labels.repositoryId, repoData.id),
  });
} catch (e) {}

const repo = {
  owner: repoData.owner.username,
  name: repoData.name,
  description: repoData.description,
  visibility: repoData.visibility,
  defaultBranch: repoData.defaultBranch,
  stars: repoData.starCount,
  forks: repoData.forkCount,
  watchers: repoData.watchCount,
  openIssueCount: repoData.openIssueCount,
  openPrCount: repoData.openPrCount,
};

// Default label suggestions
const defaultLabels = [
  { name: "bug", color: "#d73a4a", description: "Something isn't working" },
  { name: "enhancement", color: "#a2eeef", description: "New feature or request" },
  { name: "documentation", color: "#0075ca", description: "Improvements to docs" },
  { name: "good first issue", color: "#7057ff", description: "Good for newcomers" },
  { name: "help wanted", color: "#008672", description: "Extra attention needed" },
  { name: "question", color: "#d876e3", description: "Further info requested" },
];

function isLightColor(hex: string) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return (r * 299 + g * 587 + b * 114) / 1000 > 128;
}
---

<BaseLayout title={`Labels Â· ${repo.owner}/${repo.name}`}>
  <div class="container py-6">
    <RepoHeader repo={repo} activeTab="issues" />

    <div class="max-w-4xl mx-auto space-y-6 mt-6">
      <!-- Header -->
      <div class="flex items-center gap-3">
        <div class="p-2 rounded-lg bg-gradient-to-br from-purple-500/20 to-pink-500/20 border border-purple-500/30">
          <svg class="h-6 w-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
          </svg>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-white">Labels</h1>
          <p class="text-gray-500 text-sm">{labels.length} labels</p>
        </div>
      </div>

      <!-- Create Label Form -->
      <div class="relative">
        <div class="absolute -inset-[1px] bg-gradient-to-r from-purple-500/20 via-transparent to-pink-500/20 rounded-xl opacity-50"></div>
        <div class="relative rounded-xl border border-white/10 bg-[#0d1117]/80 backdrop-blur-sm p-6">
          <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            New Label
          </h3>
          <form id="create-label-form" class="flex flex-wrap items-end gap-4">
            <div class="flex-1 min-w-[200px]">
              <label class="block text-sm font-medium text-gray-300 mb-2">Label name</label>
              <input 
                id="name" 
                name="name" 
                placeholder="bug, feature, etc."
                required
                class="w-full rounded-lg border border-white/10 bg-white/5 px-4 py-2.5 text-white placeholder:text-gray-600 focus:outline-none focus:border-purple-500/50 focus:ring-2 focus:ring-purple-500/20 transition-all"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Color</label>
              <div class="flex gap-2 items-center">
                <input 
                  type="color" 
                  id="color" 
                  name="color" 
                  value="#6366f1"
                  class="h-10 w-14 rounded-lg border border-white/10 cursor-pointer bg-transparent"
                />
                <div id="color-preview" class="px-3 py-1 rounded-full text-sm font-medium" style="background-color: #6366f1; color: white;">
                  preview
                </div>
              </div>
            </div>
            <div class="flex-1 min-w-[200px]">
              <label class="block text-sm font-medium text-gray-300 mb-2">Description</label>
              <input 
                id="description" 
                name="description" 
                placeholder="Brief description (optional)"
                class="w-full rounded-lg border border-white/10 bg-white/5 px-4 py-2.5 text-white placeholder:text-gray-600 focus:outline-none focus:border-purple-500/50 focus:ring-2 focus:ring-purple-500/20 transition-all"
              />
            </div>
            <button 
              type="submit"
              class="inline-flex items-center gap-2 px-4 py-2.5 rounded-lg bg-gradient-to-r from-purple-500 to-pink-600 text-sm font-medium text-white shadow-lg shadow-purple-500/25 hover:shadow-purple-500/40 transition-all"
            >
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              Create
            </button>
          </form>
          <p id="create-error" class="text-red-400 text-sm mt-2 hidden"></p>
        </div>
      </div>

      <!-- Quick Start Labels -->
      {labels.length === 0 && (
        <div class="relative">
          <div class="absolute -inset-[1px] bg-gradient-to-r from-cyan-500/20 via-transparent to-blue-500/20 rounded-xl opacity-50"></div>
          <div class="relative rounded-xl border border-white/10 bg-[#0d1117]/80 backdrop-blur-sm p-6">
            <h3 class="text-lg font-semibold text-white mb-2">Quick Start</h3>
            <p class="text-gray-500 text-sm mb-4">Create common labels with one click</p>
            <div class="flex flex-wrap gap-2">
              {defaultLabels.map((label) => (
                <button
                  class="create-default-label px-3 py-1.5 rounded-full text-sm font-medium transition-all hover:scale-105"
                  style={`background-color: ${label.color}; color: ${isLightColor(label.color) ? '#000' : '#fff'}`}
                  data-name={label.name}
                  data-color={label.color}
                  data-description={label.description}
                >
                  + {label.name}
                </button>
              ))}
            </div>
          </div>
        </div>
      )}

      <!-- Labels List -->
      <div class="relative">
        <div class="absolute -inset-[1px] bg-gradient-to-r from-purple-500/20 via-transparent to-pink-500/20 rounded-xl opacity-50"></div>
        <div class="relative rounded-xl border border-white/10 bg-[#0d1117]/80 backdrop-blur-sm overflow-hidden">
          <div class="px-5 py-4 border-b border-white/5 bg-white/[0.02]">
            <h3 class="font-semibold text-white">All Labels</h3>
          </div>
          {labels.length === 0 ? (
            <div class="text-center py-16">
              <div class="relative inline-block mb-4">
                <svg class="h-16 w-16 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                </svg>
                <div class="absolute inset-0 bg-purple-500 blur-2xl opacity-20"></div>
              </div>
              <h3 class="text-lg font-semibold text-white mb-2">No labels yet</h3>
              <p class="text-gray-500">Create labels to categorize issues and pull requests</p>
            </div>
          ) : (
            <div class="divide-y divide-white/5">
              {labels.map((label: any) => (
                <div class="flex items-center justify-between p-4 hover:bg-white/[0.02] transition-colors group" data-label-id={label.id}>
                  <div class="flex items-center gap-3">
                    <span 
                      class="px-3 py-1 rounded-full text-sm font-medium"
                      style={`background-color: ${label.color}; color: ${isLightColor(label.color) ? '#000' : '#fff'}`}
                    >
                      {label.name}
                    </span>
                    {label.description && (
                      <span class="text-sm text-gray-500">{label.description}</span>
                    )}
                  </div>
                  <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button
                      class="edit-label-btn p-2 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white transition-colors"
                      data-label-id={label.id}
                      data-name={label.name}
                      data-color={label.color}
                      data-description={label.description || ''}
                      title="Edit label"
                    >
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                      </svg>
                    </button>
                    <button
                      class="delete-label-btn p-2 hover:bg-red-500/10 rounded-lg text-gray-400 hover:text-red-400 transition-colors"
                      data-label-id={label.id}
                      data-name={label.name}
                      title="Delete label"
                    >
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script define:vars={{ owner: repo.owner, repo: repo.name }}>
  // Color preview
  const colorInput = document.getElementById('color');
  const preview = document.getElementById('color-preview');
  colorInput?.addEventListener('input', (e) => {
    const color = e.target.value;
    preview.style.backgroundColor = color;
    const r = parseInt(color.slice(1, 3), 16);
    const g = parseInt(color.slice(3, 5), 16);
    const b = parseInt(color.slice(5, 7), 16);
    preview.style.color = (r * 299 + g * 587 + b * 114) / 1000 > 128 ? '#000' : '#fff';
  });

  // Create label form
  const form = document.getElementById('create-label-form');
  const errorEl = document.getElementById('create-error');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorEl.classList.add('hidden');

    const formData = new FormData(form);
    try {
      const response = await fetch(`/api/repos/${owner}/${repo}/labels`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(Object.fromEntries(formData)),
      });
      if (!response.ok) throw new Error((await response.json()).message || 'Failed');
      window.location.reload();
    } catch (error) {
      errorEl.textContent = error.message;
      errorEl.classList.remove('hidden');
    }
  });

  // Default labels
  document.querySelectorAll('.create-default-label').forEach(btn => {
    btn.addEventListener('click', async () => {
      try {
        const response = await fetch(`/api/repos/${owner}/${repo}/labels`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: btn.dataset.name,
            color: btn.dataset.color,
            description: btn.dataset.description,
          }),
        });
        if (!response.ok) throw new Error('Failed');
        btn.remove();
      } catch (e) {
        alert('Failed to create label');
      }
    });
  });

  // Delete label
  document.querySelectorAll('.delete-label-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!confirm(`Delete label "${btn.dataset.name}"?`)) return;
      try {
        const response = await fetch(`/api/repos/${owner}/${repo}/labels/${btn.dataset.labelId}`, {
          method: 'DELETE',
        });
        if (!response.ok) throw new Error('Failed');
        btn.closest('[data-label-id]').remove();
      } catch (e) {
        alert('Failed to delete label');
      }
    });
  });
</script>
