---
import BaseLayout from "@/layouts/BaseLayout.astro";
import RepoHeader from "@/components/repo/RepoHeader.astro";
import { getDatabase, schema } from "@/db";
import { eq, and, sql, desc, gte, count } from "drizzle-orm";
import { canReadRepo } from "@/lib/permissions";
import { getContributors, getCommits } from "@/lib/git";
import { resolveRepoPath } from "@/lib/git-storage";
import {
    GitCommit,
    GitPullRequest,
    AlertCircle,
    Users,
    Activity,
} from "lucide-react";

const { owner: ownerName, repo: repoName } = Astro.params;
const db = getDatabase();

// 1. Fetch Repo & Owner
const user = await db.query.users.findFirst({
    where: eq(schema.users.username, ownerName!),
});

if (!user) return Astro.redirect("/404");

const repoData = await db.query.repositories.findFirst({
    where: and(
        eq(schema.repositories.ownerId, user.id),
        eq(schema.repositories.name, repoName!),
    ),
    with: {
        owner: true,
    },
});

if (!repoData) return Astro.redirect("/404");

// Check permissions
const currentUser = Astro.locals.user;
const hasAccess = await canReadRepo(currentUser?.id, repoData);

if (!hasAccess) {
    return Astro.redirect("/404");
}

const repo = {
    owner: repoData.owner.username,
    name: repoData.name,
    description: repoData.description,
    visibility: repoData.visibility,
    defaultBranch: repoData.defaultBranch,
    stars: repoData.starCount,
    forks: repoData.forkCount,
    watchers: repoData.watchCount,
    language: repoData.language || "Unknown",
    license: repoData.licenseType || "None",
    topics: repoData.topics ? JSON.parse(repoData.topics) : [],
    updatedAt: repoData.updatedAt,
    openPrCount: repoData.openPrCount,
    openIssueCount: 0, // Placeholder, fetched below
};

// Fetch real issue count
const issueCountResult = (await db
    // @ts-expect-error: count argument mismatch
    .select({ count: sql<number>`count(*)` })
    .from(schema.issues)
    .where(
        and(
            eq(schema.issues.repositoryId, repoData.id),
            eq(schema.issues.state, "open"),
        ),
    )) as { count: number }[];

repo.openIssueCount = issueCountResult[0]?.count || 0;

// Gather Insights Data

// Resolve disk path for git operations (handles cloud storage)
const resolvedLocalPath = await resolveRepoPath(repoData.diskPath);

// 1. Contributors
const contributors = await getContributors(resolvedLocalPath);

// 2. Recent Commits (Pulse - e.g., last month)
// For now, simple last 50 commits
const recentCommits = await getCommits(resolvedLocalPath, { limit: 20 });

// 3. Issue/PR Stats (Last 30 days)
const thirtyDaysAgo = new Date();
thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

const [recentIssues] = await (db as any)
    .select({ count: count() })
    .from(schema.issues)
    .where(
        and(
            eq(schema.issues.repositoryId, repoData.id),
            gte(schema.issues.createdAt, thirtyDaysAgo),
        ),
    );
const [recentPRs] = await (db as any)
    .select({ count: count() })
    .from(schema.pullRequests)
    .where(
        and(
            eq(schema.pullRequests.repositoryId, repoData.id),
            gte(schema.pullRequests.createdAt, thirtyDaysAgo),
        ),
    );
const [closedIssues] = await (db as any)
    .select({ count: count() })
    .from(schema.issues)
    .where(
        and(
            eq(schema.issues.repositoryId, repoData.id),
            eq(schema.issues.state, "closed"),
            gte(schema.issues.updatedAt, thirtyDaysAgo),
        ),
    );
const [mergedPRs] = await (db as any)
    .select({ count: count() })
    .from(schema.pullRequests)
    .where(
        and(
            eq(schema.pullRequests.repositoryId, repoData.id),
            eq(schema.pullRequests.state, "merged"),
            gte(schema.pullRequests.updatedAt, thirtyDaysAgo),
        ),
    );
---

<BaseLayout title={`Insights Â· ${repo.owner}/${repo.name}`}>
    <div class="container py-6">
        <RepoHeader repo={repo} activeTab="insights" />

        <div class="grid gap-8 md:grid-cols-[240px_1fr]">
            <!-- Sidebar -->
            <aside class="space-y-1">
                <a
                    href="#"
                    class="flex items-center gap-2 px-3 py-2 text-sm font-medium bg-muted text-primary rounded-md"
                >
                    <Activity className="h-4 w-4" />
                    Pulse
                </a>
                <a
                    href="#"
                    class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-muted-foreground hover:bg-muted/50 rounded-md"
                >
                    <Users className="h-4 w-4" />
                    Contributors
                </a>
                <div
                    class="px-3 py-2 text-xs font-semibold text-muted-foreground uppercase mt-4"
                >
                    Graphs
                </div>
                <span
                    class="flex items-center gap-2 px-3 py-2 text-sm text-muted-foreground cursor-not-allowed opacity-60"
                >
                    Code Frequency
                </span>
                <span
                    class="flex items-center gap-2 px-3 py-2 text-sm text-muted-foreground cursor-not-allowed opacity-60"
                >
                    Commits
                </span>
                <span
                    class="flex items-center gap-2 px-3 py-2 text-sm text-muted-foreground cursor-not-allowed opacity-60"
                >
                    Network
                </span>
            </aside>

            <!-- Content -->
            <div class="space-y-8">
                <!-- Pulse Section -->
                <section>
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold tracking-tight">Pulse</h2>
                        <p class="text-muted-foreground">
                            Activity overview for the last 30 days.
                        </p>
                    </div>

                    <div class="grid gap-4 md:grid-cols-2">
                        <div
                            class="rounded-lg border bg-card text-card-foreground shadow-sm p-6"
                        >
                            <div class="flex items-center gap-4">
                                <div
                                    class="p-2 bg-blue-100 dark:bg-blue-900/20 rounded-full"
                                >
                                    <GitPullRequest
                                        className="h-6 w-6 text-blue-600 dark:text-blue-400"
                                    />
                                </div>
                                <div>
                                    <p
                                        class="text-sm font-medium text-muted-foreground"
                                    >
                                        Active Pull Requests
                                    </p>
                                    <div class="flex items-baseline gap-2">
                                        <h3 class="text-2xl font-bold">
                                            {recentPRs?.count || 0}
                                        </h3>
                                        <span
                                            class="text-sm text-muted-foreground"
                                            >opened</span
                                        >
                                    </div>
                                    <div
                                        class="text-sm text-muted-foreground mt-1"
                                    >
                                        {mergedPRs?.count || 0} merged
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div
                            class="rounded-lg border bg-card text-card-foreground shadow-sm p-6"
                        >
                            <div class="flex items-center gap-4">
                                <div
                                    class="p-2 bg-purple-100 dark:bg-purple-900/20 rounded-full"
                                >
                                    <AlertCircle
                                        className="h-6 w-6 text-purple-600 dark:text-purple-400"
                                    />
                                </div>
                                <div>
                                    <p
                                        class="text-sm font-medium text-muted-foreground"
                                    >
                                        Active Issues
                                    </p>
                                    <div class="flex items-baseline gap-2">
                                        <h3 class="text-2xl font-bold">
                                            {recentIssues?.count || 0}
                                        </h3>
                                        <span
                                            class="text-sm text-muted-foreground"
                                            >opened</span
                                        >
                                    </div>
                                    <div
                                        class="text-sm text-muted-foreground mt-1"
                                    >
                                        {closedIssues?.count || 0} closed
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Contributors Section -->
                <section>
                    <div class="mb-6 flex items-center justify-between">
                        <h2 class="text-xl font-bold tracking-tight">
                            Contributors
                        </h2>
                    </div>

                    <div class="rounded-lg border">
                        {
                            contributors.length > 0 ? (
                                <div class="divide-y">
                                    {contributors.map((contributor, i) => (
                                        <div class="flex items-center justify-between p-4 hover:bg-muted/30">
                                            <div class="flex items-center gap-4">
                                                <div class="h-10 w-10 rounded-full bg-muted flex items-center justify-center text-lg font-medium text-muted-foreground">
                                                    {contributor.name[0]?.toUpperCase()}
                                                </div>
                                                <div>
                                                    <div class="font-medium">
                                                        {contributor.name}
                                                    </div>
                                                    <div class="text-sm text-muted-foreground">
                                                        {contributor.email}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-sm font-bold">
                                                    {contributor.commits}
                                                </div>
                                                <div class="text-xs text-muted-foreground">
                                                    commits
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div class="p-8 text-center text-muted-foreground">
                                    No contributor data available.
                                </div>
                            )
                        }
                    </div>
                </section>
            </div>
        </div>
    </div>
</BaseLayout>
