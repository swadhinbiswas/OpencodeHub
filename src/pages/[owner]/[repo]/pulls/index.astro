---
import RepoHeader from "@/components/repo/RepoHeader.astro";
import PullRequestsList from "@/components/pulls/PullRequestsList";
import { getDatabase, schema } from "@/db";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { canReadRepo } from "@/lib/permissions";
import { and, desc, eq, sql, count } from "drizzle-orm";

const { owner: ownerName, repo: repoName } = Astro.params;
const db = getDatabase();

// 1. Fetch Repo & Owner
const user = await db.query.users.findFirst({
  where: eq(schema.users.username, ownerName!),
});

if (!user) return Astro.redirect("/404");

const repoData = await db.query.repositories.findFirst({
  where: and(
    eq(schema.repositories.ownerId, user.id),
    eq(schema.repositories.name, repoName!),
  ),
  with: {
    owner: true,
  },
});

if (!repoData) return Astro.redirect("/404");

// Check permissions
const currentUser = Astro.locals.user;
const hasAccess = await canReadRepo(currentUser?.id, repoData);

if (!hasAccess) {
  return Astro.redirect("/404");
}

// Fetch issue count
const issueCountResult = (await db
  // @ts-expect-error: count argument mismatch
  .select({ count: sql<number>`count(*)` })
  .from(schema.issues)
  .where(
    and(
      eq(schema.issues.repositoryId, repoData.id),
      eq(schema.issues.state, "open"),
    ),
  )
  ) as { count: number }[];

const openIssueCount = issueCountResult?.count || 0;

// 2. Fetch Pull Requests
const prsList = await db.query.pullRequests.findMany({
  where: eq(schema.pullRequests.repositoryId, repoData.id),
  orderBy: [desc(schema.pullRequests.createdAt)],
  with: {
    author: true,
    labels: {
      with: {
        label: true,
      },
    },
  },
});

const openCount = prsList.filter((pr) => pr.state === "open").length;
const closedCount = prsList.filter(
  (pr) => pr.state === "closed" || pr.state === "merged",
).length;

const repo = {
  owner: repoData.owner.username,
  name: repoData.name,
  description: repoData.description,
  visibility: repoData.visibility,
  defaultBranch: repoData.defaultBranch,
  stars: repoData.starCount,
  forks: repoData.forkCount,
  watchers: repoData.watchCount,
  language: repoData.language || "Unknown",
  license: repoData.licenseType || "None",
  topics: repoData.topics ? JSON.parse(repoData.topics) : [],
  updatedAt: repoData.updatedAt,
  httpCloneUrl: repoData.httpCloneUrl,
  sshCloneUrl: repoData.sshCloneUrl,
  openIssueCount: openIssueCount,
  openPrCount: openCount,
};

// Format PRs for React component
const formattedPRs = prsList.map((pr) => ({
  id: pr.id,
  number: pr.number,
  title: pr.title,
  state: pr.state as "open" | "closed" | "merged",
  createdAt: pr.createdAt,
  commentCount: pr.commentCount || 0,
  sourceBranch: pr.headBranch || "",
  targetBranch: pr.baseBranch || "",
  author: {
    username: pr.author.username,
    avatarUrl: pr.author.avatarUrl || undefined,
  },
  labels:
    pr.labels?.map((pl) => ({
      id: pl.label.id,
      name: pl.label.name,
      color: pl.label.color,
    })) || [],
  isDraft: pr.isDraft || false,
}));
---

<BaseLayout title={`Pull Requests Â· ${repo.owner}/${repo.name}`}>
  <div class="container py-6">
    <RepoHeader repo={repo} activeTab="pulls" />

    <div class="mt-6">
      <PullRequestsList
        client:load
        pullRequests={formattedPRs}
        openCount={openCount}
        closedCount={closedCount}
        repoOwner={repo.owner}
        repoName={repo.name}
      />
    </div>
  </div>
</BaseLayout>
