---
import BaseLayout from "@/layouts/BaseLayout.astro";
import {
  GitBranch,
  Code,
  Tag,
  ChevronDown,
  Copy,
  Download,
  GitCommit,
  FileText,
  Clock,
} from "lucide-react";
import { getDatabase, schema } from "@/db";
import { eq, and, sql, count } from "drizzle-orm";
import {
  listFiles,
  getLastCommit,
  getCommits,
  getFileContent,
  getBranches,
  getCommitCount,
  isRepoEmpty,
} from "@/lib/git";
import { EmptyRepoSetup } from "@/components/repo/EmptyRepoSetup";
import { resolveRepoPath } from "@/lib/git-storage";
import { canReadRepo } from "@/lib/permissions";
import { renderMarkdown } from "@/lib/markdown";
import RepoHeader from "@/components/repo/RepoHeader.astro";
import FileExplorer from "@/components/repo/FileExplorer.astro";
import { RepoControls } from "@/components/repo/RepoControls";
import { Card } from "@/components/ui/card";

const { owner: ownerName, repo: repoName } = Astro.params;
const db = getDatabase();

// 1. Fetch Repo & Owner
const user = await db.query.users.findFirst({
  where: eq(schema.users.username, ownerName!),
});

if (!user) return Astro.redirect("/404");

const repoData = await db.query.repositories.findFirst({
  where: and(
    eq(schema.repositories.ownerId, user.id),
    eq(schema.repositories.name, repoName!),
  ),
  with: {
    owner: true,
  },
});

if (!repoData) return Astro.redirect("/404");

// Check permissions
const currentUser = Astro.locals.user;
const hasAccess = await canReadRepo(currentUser?.id, repoData);

if (!hasAccess) {
  return Astro.redirect("/404");
}

// Fetch issue count
const issueCountResult = await (db as any)
  .select({ count: count() })
  .from(schema.issues)
  .where(
    and(
      eq(schema.issues.repositoryId, repoData.id),
      eq(schema.issues.state, "open"),
    ),
  );

const openIssueCount = issueCountResult?.[0]?.count || 0;

// Resolve the disk path for git operations (handles cloud storage)
const resolvedLocalPath = await resolveRepoPath(repoData.diskPath);

// Check if repo is empty
const isEmptyRepo = await isRepoEmpty(resolvedLocalPath);

// 2. Git Operations
const currentBranch = repoData.defaultBranch;
const currentPath = "";
let files: any[] = [];
let latestCommit: any = null;
let totalCommits = 0;
let readme = "";

// Format dates helper
function timeAgo(date: Date | string | number) {
  if (!date) return "";
  const seconds = Math.floor(
    (new Date().getTime() - new Date(date).getTime()) / 1000,
  );
  let interval = seconds / 31536000;
  if (interval > 1) return Math.floor(interval) + " years ago";
  interval = seconds / 2592000;
  if (interval > 1) return Math.floor(interval) + " months ago";
  interval = seconds / 86400;
  if (interval > 1) return Math.floor(interval) + " days ago";
  interval = seconds / 3600;
  if (interval > 1) return Math.floor(interval) + " hours ago";
  interval = seconds / 60;
  if (interval > 1) return Math.floor(interval) + " minutes ago";
  return Math.floor(seconds) + " seconds ago";
}

try {
  // Get files
  const gitFiles = await listFiles(
    resolvedLocalPath,
    currentBranch,
    currentPath,
  );

  // Map to UI format with commits
  files = await Promise.all(
    gitFiles.map(async (f) => {
      const commit = await getLastCommit(
        resolvedLocalPath,
        currentBranch,
        f.path,
      );

      const lastCommit = commit
        ? {
            message: commit.message,
            date: timeAgo(commit.authorDate),
            hash: commit.sha,
          }
        : undefined;

      return {
        name: f.name,
        type: f.type,
        lastCommit,
      };
    }),
  );

  // Sort: directories first
  files.sort((a, b) => {
    if (a.type === "directory" && b.type !== "directory") return -1;
    if (a.type !== "directory" && b.type === "directory") return 1;
    return a.name.localeCompare(b.name);
  });

  // Get latest commit for the directory
  const commits = await getCommits(resolvedLocalPath, {
    limit: 1,
    ref: currentBranch,
    path: currentPath,
  });
  if (commits.length > 0) {
    latestCommit = commits[0];
  }

  // Get total commit count
  totalCommits = await getCommitCount(resolvedLocalPath, currentBranch);

  // Get README
  const readmeFile = files.find((f) => f.name.toLowerCase() === "readme.md");
  if (readmeFile) {
    const content = await getFileContent(
      resolvedLocalPath,
      readmeFile.name,
      currentBranch,
    );
    if (content && !content.isBinary) {
      readme = await renderMarkdown(content.content);
    }
  }
} catch (error) {
  console.error("Git error:", error);
  // return Astro.redirect('/404'); // Don't redirect on git error, show empty repo maybe?
}

// 3. Get Branches
let branches: string[] = [repoData.defaultBranch];
try {
  const branchInfos = await getBranches(resolvedLocalPath);
  branches = branchInfos.map((b) => b.name);
} catch (e) {
  console.error("Error fetching branches", e);
}

const repo = {
  owner: repoData.owner.username,
  name: repoData.name,
  description: repoData.description,
  visibility: repoData.visibility,
  defaultBranch: repoData.defaultBranch,
  stars: repoData.starCount,
  forks: repoData.forkCount,
  watchers: repoData.watchCount,
  language: repoData.language || "Unknown",
  license: repoData.licenseType || "None",
  topics: repoData.topics ? JSON.parse(repoData.topics) : [],
  updatedAt: repoData.updatedAt,
  httpCloneUrl: repoData.httpCloneUrl,
  sshCloneUrl: repoData.sshCloneUrl,
  openIssueCount: openIssueCount,
  openPrCount: repoData.openPrCount,
  website: repoData.website,
};
---

<BaseLayout title={`${repo.owner}/${repo.name} - OpenCodeHub`}>
  <div class="container py-6">
    <RepoHeader repo={repo} activeTab="code" />

    <div class="grid gap-6 lg:grid-cols-4">
      <!-- Main Content -->
      <div class="lg:col-span-3 space-y-4">
        <!-- Branch/Clone Bar -->
        <RepoControls
          client:load
          owner={repo.owner}
          repo={repo.name}
          currentBranch={currentBranch}
          branches={branches}
          httpCloneUrl={repo.httpCloneUrl ||
            `${process.env.SITE_URL || "http://localhost:3000"}/${repo.owner}/${repo.name}.git`}
          sshCloneUrl={repo.sshCloneUrl ||
            `${process.env.GIT_SSH_URL || `ssh://git@localhost:${process.env.GIT_SSH_PORT || 2222}`}/${repo.owner}/${repo.name}.git`}
        />

        <!-- File Browser -->
        <div class="space-y-4">
          <!-- Latest Commit -->
          {
            isEmptyRepo ? (
              <EmptyRepoSetup
                client:load
                owner={repo.owner}
                repo={repo.name}
                httpCloneUrl={
                  repo.httpCloneUrl ||
                  `http://localhost:3000/${repo.owner}/${repo.name}.git`
                }
                sshCloneUrl={
                  repo.sshCloneUrl ||
                  `git@localhost:${repo.owner}/${repo.name}.git`
                }
              />
            ) : latestCommit && latestCommit.authorName ? (
              <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 rounded-lg border bg-card p-4 text-sm shadow-sm">
                <div class="flex items-center gap-3 overflow-hidden">
                  <div class="h-8 w-8 shrink-0 rounded-full bg-muted flex items-center justify-center border text-xs font-medium">
                    {latestCommit.authorName[0]?.toUpperCase()}
                  </div>
                  <div class="flex flex-col min-w-0">
                    <div class="flex items-center gap-2 truncate">
                      <a
                        href="#"
                        class="font-semibold hover:text-primary hover:underline truncate"
                      >
                        {latestCommit.authorName}
                      </a>
                      <span class="text-muted-foreground truncate hidden sm:inline">
                        {latestCommit.message}
                      </span>
                    </div>
                    <div class="flex sm:hidden text-muted-foreground truncate text-xs">
                      {latestCommit.message}
                    </div>
                    <div class="flex items-center gap-2 text-xs text-muted-foreground">
                      <span>committed {timeAgo(latestCommit.authorDate)}</span>
                      {latestCommit.verification?.status === "G" && (
                        <div
                          class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-green-100 text-green-800 border border-green-200 ml-1"
                          title={`Signed by ${latestCommit.verification.signerName} (${latestCommit.verification.signerKeyId})`}
                        >
                          Verified
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                <div class="flex items-center gap-3 shrink-0 ml-11 sm:ml-0">
                  <div class="flex items-center border rounded-md overflow-hidden bg-muted/30">
                    <a
                      href={`/${repo.owner}/${repo.name}/commit/${latestCommit.sha}`}
                      class="px-3 py-1.5 hover:bg-muted hover:text-primary font-mono text-xs transition-colors border-r"
                    >
                      {latestCommit.sha.substring(0, 7)}
                    </a>
                    <a
                      href={`/${repo.owner}/${repo.name}/commits/${currentBranch}`}
                      class="px-3 py-1.5 hover:bg-muted hover:text-primary text-xs flex items-center gap-1.5 transition-colors"
                    >
                      <Clock className="h-3.5 w-3.5" />
                      <span class="font-medium">{totalCommits}</span>
                      <span class="sr-only">commits</span>
                    </a>
                  </div>
                </div>
              </div>
            ) : (
              <EmptyRepoSetup
                client:load
                owner={repo.owner}
                repo={repo.name}
                httpCloneUrl={
                  repo.httpCloneUrl ||
                  `${process.env.SITE_URL || "http://localhost:3000"}/${repo.owner}/${repo.name}.git`
                }
                sshCloneUrl={
                  repo.sshCloneUrl ||
                  `${process.env.GIT_SSH_URL || `ssh://git@localhost:${process.env.GIT_SSH_PORT || 2222}`}/${repo.owner}/${repo.name}.git`
                }
              />
            )
          }

          <!-- File List -->
          <Card className="overflow-hidden">
            <FileExplorer
              owner={repo.owner}
              repo={repo.name}
              branch={currentBranch}
              path={currentPath}
              files={files}
            />
          </Card>

          <!-- README -->
          {
            readme && (
              <Card className="mt-8 overflow-hidden">
                <div class="flex items-center gap-2 border-b px-4 py-3 bg-muted/30">
                  <FileText className="h-4 w-4 text-muted-foreground" />
                  <span class="font-medium text-sm">README.md</span>
                </div>
                <div
                  class="p-6 prose prose-sm dark:prose-invert max-w-none prose-headings:border-b prose-headings:pb-2 prose-img:rounded-lg"
                  set:html={readme}
                />
              </Card>
            )
          }
        </div>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- About -->
        <div class="border-b border-white/10 pb-6">
          <h3 class="font-semibold text-white mb-3">About</h3>
          <p class="text-gray-400 text-sm leading-relaxed mb-4">
            {repo.description || "No description provided."}
          </p>

          {
            repo.website && (
              <a
                href={repo.website}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-2 text-sm text-cyan-400 hover:underline mb-3"
              >
                <svg
                  class="h-4 w-4 flex-shrink-0"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
                  />
                </svg>
                <span class="truncate">{repo.website}</span>
              </a>
            )
          }

          <div class="space-y-2.5 text-sm text-gray-500">
            <div class="flex items-center gap-2">
              <svg
                class="h-4 w-4 flex-shrink-0"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"
                ></path>
              </svg>
              <span>{repo.license || "None"} license</span>
            </div>
            <div class="flex items-center gap-2">
              <svg
                class="h-4 w-4 flex-shrink-0"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>Updated {timeAgo(repo.updatedAt)}</span>
            </div>
          </div>
        </div>

        <!-- Stats -->
        <div class="flex flex-wrap gap-4 text-sm">
          <a
            href={`/${repo.owner}/${repo.name}/stargazers`}
            class="flex items-center gap-1.5 text-gray-400 hover:text-cyan-400 transition-colors"
          >
            <svg
              class="h-4 w-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"
              ></path>
            </svg>
            <span class="font-medium text-white">{repo.stars || 0}</span>
            <span>stars</span>
          </a>
          <a
            href={`/${repo.owner}/${repo.name}/forks`}
            class="flex items-center gap-1.5 text-gray-400 hover:text-cyan-400 transition-colors"
          >
            <svg
              class="h-4 w-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"
              ></path>
            </svg>
            <span class="font-medium text-white">{repo.forks || 0}</span>
            <span>forks</span>
          </a>
          <div class="flex items-center gap-1.5 text-gray-400">
            <svg
              class="h-4 w-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
              ></path>
            </svg>
            <span class="font-medium text-white">{repo.watchers || 0}</span>
            <span>watching</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>
