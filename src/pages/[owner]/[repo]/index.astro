---
import BaseLayout from "@/layouts/BaseLayout.astro";
import {
  GitBranch,
  Code,
  Tag,
  ChevronDown,
  Copy,
  Download,
  GitCommit,
  FileText,
  Clock,
} from "lucide-react";
import { getDatabase, schema } from "@/db";
import { eq, and, sql } from "drizzle-orm";
import {
  listFiles,
  getLastCommit,
  getCommits,
  getFileContent,
  getBranches,
} from "@/lib/git";
import { canReadRepo } from "@/lib/permissions";
import { renderMarkdown } from "@/lib/markdown";
import RepoHeader from "@/components/repo/RepoHeader.astro";
import FileExplorer from "@/components/repo/FileExplorer.astro";

const { owner: ownerName, repo: repoName } = Astro.params;
const db = getDatabase();

// 1. Fetch Repo & Owner
const user = await db.query.users.findFirst({
  where: eq(schema.users.username, ownerName!),
});

if (!user) return Astro.redirect("/404");

const repoData = await db.query.repositories.findFirst({
  where: and(
    eq(schema.repositories.ownerId, user.id),
    eq(schema.repositories.name, repoName!)
  ),
  with: {
    owner: true,
  },
});

if (!repoData) return Astro.redirect("/404");

// Check permissions
const currentUser = Astro.locals.user;
const hasAccess = await canReadRepo(currentUser?.id, repoData);

if (!hasAccess) {
  return Astro.redirect("/404");
}

// Fetch issue count
const issueCountResult = await db
  .select({ count: sql<number>`count(*)` })
  .from(schema.issues)
  .where(
    and(
      eq(schema.issues.repositoryId, repoData.id),
      eq(schema.issues.state, "open")
    )
  )
  .get();

const openIssueCount = issueCountResult?.count || 0;

// 2. Git Operations
const currentBranch = repoData.defaultBranch;
const currentPath = "";
let files: any[] = [];
let latestCommit: any = null;
let readme = "";

// Format dates helper
function timeAgo(date: Date | string | number) {
  if (!date) return "";
  const seconds = Math.floor(
    (new Date().getTime() - new Date(date).getTime()) / 1000
  );
  let interval = seconds / 31536000;
  if (interval > 1) return Math.floor(interval) + " years ago";
  interval = seconds / 2592000;
  if (interval > 1) return Math.floor(interval) + " months ago";
  interval = seconds / 86400;
  if (interval > 1) return Math.floor(interval) + " days ago";
  interval = seconds / 3600;
  if (interval > 1) return Math.floor(interval) + " hours ago";
  interval = seconds / 60;
  if (interval > 1) return Math.floor(interval) + " minutes ago";
  return Math.floor(seconds) + " seconds ago";
}

try {
  // Get files
  const gitFiles = await listFiles(
    repoData.diskPath,
    currentBranch,
    currentPath
  );

  // Map to UI format with commits
  files = await Promise.all(
    gitFiles.map(async (f) => {
      const commit = await getLastCommit(
        repoData.diskPath,
        currentBranch,
        f.path
      );

      const lastCommit = commit
        ? {
            message: commit.message,
            date: timeAgo(commit.authorDate),
            hash: commit.sha,
          }
        : undefined;

      return {
        name: f.name,
        type: f.type,
        lastCommit,
      };
    })
  );

  // Sort: directories first
  files.sort((a, b) => {
    if (a.type === "directory" && b.type !== "directory") return -1;
    if (a.type !== "directory" && b.type === "directory") return 1;
    return a.name.localeCompare(b.name);
  });

  // Get latest commit for the directory
  const commits = await getCommits(repoData.diskPath, {
    limit: 1,
    ref: currentBranch,
    path: currentPath,
  });
  if (commits.length > 0) {
    latestCommit = commits[0];
  }

  // Get README
  const readmeFile = files.find((f) => f.name.toLowerCase() === "readme.md");
  if (readmeFile) {
    const content = await getFileContent(
      repoData.diskPath,
      readmeFile.name,
      currentBranch
    );
    if (content && !content.isBinary) {
      readme = await renderMarkdown(content.content);
    }
  }
} catch (error) {
  console.error("Git error:", error);
  // return Astro.redirect('/404'); // Don't redirect on git error, show empty repo maybe?
}

// 3. Get Branches
let branches: string[] = [repoData.defaultBranch];
try {
    const branchInfos = await getBranches(repoData.diskPath);
    branches = branchInfos.map(b => b.name);
} catch (e) {
    console.error("Error fetching branches", e);
}

const repo = {
  owner: repoData.owner.username,
  name: repoData.name,
  description: repoData.description,
  visibility: repoData.visibility,
  defaultBranch: repoData.defaultBranch,
  stars: repoData.starCount,
  forks: repoData.forkCount,
  watchers: repoData.watchCount,
  language: repoData.language || "Unknown",
  license: repoData.licenseType || "None",
  topics: repoData.topics ? JSON.parse(repoData.topics) : [],
  updatedAt: repoData.updatedAt,
  httpCloneUrl: repoData.httpCloneUrl,
  sshCloneUrl: repoData.sshCloneUrl,
  openIssueCount: openIssueCount,
  openPrCount: repoData.openPrCount,
};
---

<BaseLayout title={`${repo.owner}/${repo.name} - OpenCodeHub`}>
  <div class="container py-6">
    <RepoHeader repo={repo} activeTab="code" />

    <div class="grid gap-6 lg:grid-cols-4">
      <!-- Main Content -->
      <div class="lg:col-span-3 space-y-4">
        <!-- Branch/Clone Bar -->
        <div
          class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between"
        >
          <div class="flex items-center gap-2">
            <!-- Branch Selector -->
            <div class="relative">
              <button
                class="inline-flex items-center gap-2 rounded-md border bg-background px-3 py-1.5 text-sm font-medium shadow-sm hover:bg-accent"
                id="branch-btn"
              >
                <GitBranch className="h-4 w-4" />
                {currentBranch}
                <ChevronDown className="h-4 w-4" />
              </button>
              <div
                id="branch-dropdown"
                class="hidden absolute left-0 top-full mt-1 w-64 rounded-md border bg-popover p-2 shadow-lg z-10"
              >
                <input
                  type="search"
                  placeholder="Find a branch..."
                  class="w-full mb-2 h-8 rounded-md border bg-background px-3 text-sm"
                />
                <div class="max-h-64 overflow-y-auto">
                  <div
                    class="text-xs font-semibold text-muted-foreground px-2 py-1"
                  >
                    Branches
                  </div>
                  {
                    branches.map((b) => (
                      <a
                        href={`/${repo.owner}/${repo.name}/tree/${b}`}
                        class={`flex items-center gap-2 rounded-sm px-2 py-1.5 text-sm hover:bg-accent ${b === currentBranch ? "bg-accent" : ""}`}
                      >
                        {b === currentBranch && (
                          <span class="text-primary">✓</span>
                        )}
                        {b}
                      </a>
                    ))
                  }
                </div>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <!-- Clone Button -->
            <div class="relative">
              <button
                class="inline-flex items-center gap-2 rounded-md bg-primary px-3 py-1.5 text-sm font-medium text-primary-foreground shadow hover:bg-primary/90"
                id="clone-btn"
              >
                <Code className="h-4 w-4" />
                Code
                <ChevronDown className="h-4 w-4" />
              </button>
              <div
                id="clone-dropdown"
                class="hidden absolute right-0 top-full mt-1 w-80 rounded-md border bg-popover p-4 shadow-lg z-10"
              >
                <div class="space-y-4">
                  <div>
                    <div class="flex items-center gap-2 mb-2">
                      <button
                        id="https-tab"
                        class="text-sm font-medium border-b-2 border-primary pb-1"
                        >HTTPS</button
                      >
                      <button
                        id="ssh-tab"
                        class="text-sm font-medium text-muted-foreground pb-1 border-b-2 border-transparent"
                        >SSH</button
                      >
                    </div>
                    <div class="flex items-center gap-2">
                      <input
                        type="text"
                        readonly
                        id="clone-url"
                        value={repo.httpCloneUrl || `http://localhost:3000/${repo.owner}/${repo.name}.git`}
                        data-https={repo.httpCloneUrl || `http://localhost:3000/${repo.owner}/${repo.name}.git`}
                        data-ssh={repo.sshCloneUrl || `git@localhost:${repo.owner}/${repo.name}.git`}
                        class="flex-1 h-8 rounded-md border bg-muted px-2 text-xs font-mono"
                      />
                      <button
                        id="copy-url-btn"
                        class="inline-flex items-center justify-center h-8 w-8 rounded-md border hover:bg-accent"
                        title="Copy to clipboard"
                      >
                        <Copy className="h-4 w-4" />
                      </button>
                    </div>
                  </div>
                  <div class="border-t pt-4 space-y-2">
                    <a
                      href={`/${repo.owner}/${repo.name}/archive/refs/heads/${currentBranch}.zip`}
                      class="flex items-center gap-2 text-sm hover:text-primary"
                    >
                      <Download className="h-4 w-4" />
                      Download ZIP
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- File Browser -->
        <div class="space-y-4">
          <!-- Latest Commit -->
          {
            latestCommit && latestCommit.authorName ? (
              <div class="flex items-center gap-4 rounded-lg border bg-muted/30 p-4">
                <div class="h-8 w-8 rounded-full bg-muted flex items-center justify-center">
                  <span class="text-sm font-medium">
                    {latestCommit.authorName[0].toUpperCase()}
                  </span>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 text-sm">
                    <a href="#" class="font-medium hover:text-primary">
                      {latestCommit.authorName}
                    </a>
                    <a href="#" class="truncate hover:text-primary">
                      {latestCommit.message}
                    </a>
                  </div>
                  <div class="flex items-center gap-2 text-xs text-muted-foreground">
                    <a href="#" class="font-mono hover:text-primary">
                      {latestCommit.sha.substring(0, 7)}
                    </a>
                    <span>·</span>
                    <span>committed {timeAgo(latestCommit.authorDate)}</span>
                  </div>
                </div>
                <a
                  href={`/${repo.owner}/${repo.name}/commits/${currentBranch}`}
                  class="text-sm text-muted-foreground hover:text-primary whitespace-nowrap"
                >
                  <GitCommit className="h-4 w-4 inline mr-1" />
                  History
                </a>
              </div>
            ) : (
              <div class="p-4 text-sm text-muted-foreground border rounded-lg">
                No commits yet.
              </div>
            )
          }

          <!-- File List -->
          <FileExplorer
            owner={repo.owner}
            repo={repo.name}
            branch={currentBranch}
            path={currentPath}
            files={files}
          />

          <!-- README -->
          {
            readme && (
              <div class="rounded-lg border mt-8">
                <div class="flex items-center gap-2 border-b px-4 py-3 bg-muted/30">
                  <FileText className="h-4 w-4" />
                  <span class="font-medium">README.md</span>
                </div>
                <div
                  class="p-6 prose dark:prose-invert max-w-none"
                  set:html={readme}
                />
              </div>
            )
          }
        </div>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- About -->
        <div class="border-b border-white/10 pb-6">
          <h3 class="font-semibold text-white mb-3">About</h3>
          <p class="text-gray-400 text-sm leading-relaxed mb-4">
            {repo.description || "No description provided."}
          </p>
          
          {repo.website && (
            <a
              href={repo.website}
              target="_blank"
              rel="noopener noreferrer"
              class="flex items-center gap-2 text-sm text-cyan-400 hover:underline mb-3"
            >
              <svg class="h-4 w-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
              </svg>
              <span class="truncate">{repo.website}</span>
            </a>
          )}
          
          <div class="space-y-2.5 text-sm text-gray-500">
            <div class="flex items-center gap-2">
              <svg class="h-4 w-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path>
              </svg>
              <span>{repo.license || "None"} license</span>
            </div>
            <div class="flex items-center gap-2">
              <svg class="h-4 w-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>Updated {timeAgo(repo.updatedAt)}</span>
            </div>
          </div>
        </div>
        
        <!-- Stats -->
        <div class="flex flex-wrap gap-4 text-sm">
          <a href={`/${repo.owner}/${repo.name}/stargazers`} class="flex items-center gap-1.5 text-gray-400 hover:text-cyan-400 transition-colors">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
            </svg>
            <span class="font-medium text-white">{repo.stars || 0}</span>
            <span>stars</span>
          </a>
          <a href={`/${repo.owner}/${repo.name}/forks`} class="flex items-center gap-1.5 text-gray-400 hover:text-cyan-400 transition-colors">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
            </svg>
            <span class="font-medium text-white">{repo.forks || 0}</span>
            <span>forks</span>
          </a>
          <div class="flex items-center gap-1.5 text-gray-400">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
            <span class="font-medium text-white">{repo.watchers || 0}</span>
            <span>watching</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  // Branch dropdown
  const branchBtn = document.getElementById("branch-btn");
  const branchDropdown = document.getElementById("branch-dropdown");

  branchBtn?.addEventListener("click", (e) => {
    e.stopPropagation();
    branchDropdown?.classList.toggle("hidden");
    document.getElementById("clone-dropdown")?.classList.add("hidden");
  });

  // Clone dropdown
  const cloneBtn = document.getElementById("clone-btn");
  const cloneDropdown = document.getElementById("clone-dropdown");

  cloneBtn?.addEventListener("click", (e) => {
    e.stopPropagation();
    cloneDropdown?.classList.toggle("hidden");
    branchDropdown?.classList.add("hidden");
  });

  // Close dropdowns when clicking outside
  document.addEventListener("click", () => {
    branchDropdown?.classList.add("hidden");
    cloneDropdown?.classList.add("hidden");
  });

  // HTTPS/SSH tab switching
  const httpsTab = document.getElementById("https-tab");
  const sshTab = document.getElementById("ssh-tab");
  const cloneUrl = document.getElementById("clone-url") as HTMLInputElement;

  httpsTab?.addEventListener("click", (e) => {
    e.stopPropagation();
    if (cloneUrl) {
      cloneUrl.value = cloneUrl.dataset.https || "";
    }
    httpsTab.classList.add("border-primary");
    httpsTab.classList.remove("text-muted-foreground", "border-transparent");
    sshTab?.classList.remove("border-primary");
    sshTab?.classList.add("text-muted-foreground", "border-transparent");
  });

  sshTab?.addEventListener("click", (e) => {
    e.stopPropagation();
    if (cloneUrl) {
      cloneUrl.value = cloneUrl.dataset.ssh || "";
    }
    sshTab.classList.add("border-primary");
    sshTab.classList.remove("text-muted-foreground", "border-transparent");
    httpsTab?.classList.remove("border-primary");
    httpsTab?.classList.add("text-muted-foreground", "border-transparent");
  });

  // Copy URL to clipboard
  const copyBtn = document.getElementById("copy-url-btn");
  copyBtn?.addEventListener("click", async (e) => {
    e.stopPropagation();
    if (cloneUrl) {
      await navigator.clipboard.writeText(cloneUrl.value);
      copyBtn.innerHTML = '<svg class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
      setTimeout(() => {
        copyBtn.innerHTML = '<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
      }, 2000);
    }
  });

  // Fork button
  const forkBtn = document.getElementById("fork-btn");
  forkBtn?.addEventListener("click", async () => {
    const owner = forkBtn.dataset.owner;
    const repo = forkBtn.dataset.repo;
    
    forkBtn.disabled = true;
    forkBtn.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Forking...';
    
    try {
      const response = await fetch(`/api/repos/${owner}/${repo}/fork`, {
        method: 'POST',
      });
      
      const data = await response.json();
      
      if (response.ok) {
        window.location.href = data.fork.url;
      } else if (response.status === 409) {
        // Already forked - redirect to existing fork
        window.location.href = `/${data.fork.owner}/${data.fork.name}`;
      } else {
        alert(data.message || 'Failed to fork repository');
        forkBtn.disabled = false;
        forkBtn.innerHTML = '<svg class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 5C7 3.89543 7.89543 3 9 3C10.1046 3 11 3.89543 11 5C11 5.74028 10.5978 6.38663 10 6.73244V14.0396H14.5M17 5C17 3.89543 16.1046 3 15 3C13.8954 3 13 3.89543 13 5C13 5.74028 13.4022 6.38663 14 6.73244V8.5M14.5 14.0396C14.5 15.1441 15.3954 16.0396 16.5 16.0396C17.6046 16.0396 18.5 15.1441 18.5 14.0396C18.5 12.935 17.6046 12.0396 16.5 12.0396C15.3954 12.0396 14.5 12.935 14.5 14.0396Z"></path></svg>Fork';
      }
    } catch (error) {
      console.error('Fork error:', error);
      alert('Failed to fork repository');
      forkBtn.disabled = false;
    }
  });
</script>
