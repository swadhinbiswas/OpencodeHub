---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Github } from "lucide-react";

if (Astro.locals.user) {
  return Astro.redirect("/dashboard");
}
---

<BaseLayout title="Sign up for OpenCodeHub">
  <div class="flex min-h-[calc(100vh-4rem)] items-center justify-center py-12">
    <Card className="w-full max-w-md">
      <CardHeader class="space-y-1">
        <CardTitle class="text-2xl font-bold text-center"
          >Create an account</CardTitle
        >
        <CardDescription class="text-center">
          Enter your email below to create your account
        </CardDescription>
      </CardHeader>
      <CardContent class="space-y-4">
        <form id="register-form" class="space-y-4">
          <div class="space-y-2">
            <Label htmlFor="username">Username</Label>
            <Input
              id="username"
              name="username"
              placeholder="johndoe"
              required
              minlength="2"
              maxlength="39"
            />
            <p class="text-xs text-muted-foreground">
              Only letters, numbers, and hyphens.
            </p>
          </div>
          <div class="space-y-2">
            <Label htmlFor="email">Email</Label>
            <Input
              id="email"
              name="email"
              type="email"
              placeholder="m@example.com"
              required
            />
          </div>
          <div class="space-y-2">
            <Label htmlFor="password">Password</Label>
            <Input
              id="password"
              name="password"
              type="password"
              required
              minlength="8"
            />
            <p class="text-xs text-muted-foreground">
              Must be at least 8 characters long.
            </p>
          </div>
          <div id="error-message" class="text-sm text-destructive hidden"></div>
          <Button type="submit" class="w-full">Create account</Button>
        </form>

        <div class="relative">
          <div class="absolute inset-0 flex items-center">
            <span class="w-full border-t"></span>
          </div>
          <div class="relative flex justify-center text-xs uppercase">
            <span class="bg-background px-2 text-muted-foreground">
              Or continue with
            </span>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-2">
          <Button variant="outline" disabled>
            <Github className="mr-2 h-4 w-4" />
            GitHub (Coming Soon)
          </Button>
        </div>
      </CardContent>
      <CardFooter
        class="flex flex-col space-y-2 text-center text-sm text-muted-foreground"
      >
        <div>
          Already have an account?{" "}
          <a href="/login" class="text-primary hover:underline"> Sign in </a>
        </div>
      </CardFooter>
    </Card>
  </div>
</BaseLayout>

<script>
  const form = document.getElementById("register-form") as HTMLFormElement;
  const errorMessage = document.getElementById("error-message");

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    errorMessage?.classList.add("hidden");
    errorMessage!.textContent = "";

    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    try {
      const response = await fetch("/api/auth/register", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (result.success) {
        window.location.href = "/dashboard";
      } else {
        errorMessage?.classList.remove("hidden");
        errorMessage!.textContent =
          result.error?.message || "Failed to create account";
      }
    } catch (error) {
      errorMessage?.classList.remove("hidden");
      errorMessage!.textContent = "An unexpected error occurred";
    }
  });
</script>
